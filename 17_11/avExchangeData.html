<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html data-context="Build Apps" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Exchange Data  - Legato Docs</title>
<meta content="legato™ is an open source Linux-based embedded platform designed to simplify connected IoT application development" name="description"/>
<meta content="legato, iot" name="keywords"/>
<meta content="17.11.0" name="legato-version"/>
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<link href="resources/images/legato.ico" rel="shortcut icon"/>
<link href="resources/images/legato.ico" rel="icon" type="image/x-icon"/>
<link href="resources/images/legato.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="resources/images/legato.ico" rel="apple-touch-icon" type="image/x-icon"/>
<link href="resources/css/style.css" media="screen" rel="stylesheet" type="text/css"/>
<link href="resources/css/font-awesome.css" rel="stylesheet" type="text/css"/>
<!--[if IE]>
        <script src="resources/js/html5shiv.js"></script>
        <script src="resources/js/respond.js"></script>
        <![endif]-->
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
<script src="resources/js/main.js"></script>
<script src="tocs/Build_Apps_API_Guides.json"></script>
</head>
<body>
<noscript>
<input class="modal-closing-trick" id="modal-closing-trick" type="checkbox"/>
<div id="nojs">
<label for="modal-closing-trick">
<span>You seem to not have Javascript <a href="http://enable-javascript.com">enabled</a>, so site functionality like the search and navigation tree won't work.</span>
</label>
</div>
</noscript>
<div class="wrapper">
<div class="fa fa-bars documentation" id="menu-trigger"></div>
<div id="top">
<header>
<nav>
<a class="navlink" href="/">Introduction</a><a class="navlink selected" href="buildAppsMain.html">Build Apps</a><a class="navlink" href="buildPlatformMain.html">Build Platform</a><a class="navlink" href="aboutMain.html">About</a>
</nav>
</header>
</div>
<div class="white" id="menudocumentation">
<header>
<a href="/"> <img alt="Back to Legato Homepage" id="logo" src="resources/images/legato_logo.png"/></a>
<h2>/ Build Apps</h2>
<nav class="secondary">
<a href="buildAppsConcepts.html">Concepts</a><a class="link-selected" href="apiGuidesMain.html">API Guides</a><a href="tools.html">Tools</a><a href="howToMain.html">How To</a><a href="sampleApps.html">Sample Apps</a>
</nav>
<nav class="ui-front">
<i class="fa fa-search" id="search-icon"></i>
<input id="searchbox" placeholder="Search"/>
</nav>
</header>
</div>
<div id="resizable">
<div id="left">
<div id="tree1"></div>
</div>
</div>
<div class="content">
<div class="header">
<div class="headertitle">
<h1 class="title">Exchange Data </h1> </div>
</div><div class="contents">
<div class="textblock"><p>This topic describes how to develop a Legato App that sends data to the AirVantage Server through the avcService. This tutorial explains by example how you would</p><ul>
<li>transmit data to the AirVantage Server (push)</li>
<li>read the App configuration from the AirVantage Server (variable [r])</li>
<li>write settings from AirVantage to the sample app (setting [rw])</li>
<li>send commands from AirVantage to the sample app (command [x])</li>
</ul>
<p>The underlying protocol and security stacks are provided by Legato so developers can focus on gathering data from sensors without worrying about security. To connect to the AirVantage Server the <code>avcService</code> (and dependent services) must be running on your target.</p>
<p>Steps to develop a Legato App that exchanges data with AirVantage:</p>
<p><code>1</code>. <a class="el" href="avExchangeData.html#avExchangeData_define">Develop and Install the App</a>. <br/>
<code>2</code>. <a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp">Develop and Install Legato app</a>. <br/>
<code>3</code>. <a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp">Implement Legato App</a> <br/>
<code>4</code>. <a class="el" href="avExchangeData.html#avExchangeData_exchData">Exchange data</a> between the target device and AirVantage.</p>
<h1><a class="anchor" id="avExchangeData_pre"></a>
Prerequisites</h1>
<p>This tutorial was designed on a mangOh and uses the following hardware:</p><ul>
<li><a href="https://www.sierrawireless.com/products-and-solutions/embedded-solutions/iot-modules/">AirPrime WP8548 module</a></li>
<li><a href="http://mangoh.io/">MangOH board</a></li>
<li><a href="http://fr.rs-online.com/web/p/alimentations-enfichables/7212203/">Power adapter 12Vdc 1.5A</a></li>
<li><a href="http://www.aten.com/products/productItem.php?model_no=UC232A">USB-to-Serial cable</a></li>
</ul>
<p>If you have not set up your target device yet, it is highly recommended that you visit <a href="http://mangoh.io/">mangOH.io</a> and walk through their getting started tutorials before continuing on with this tutorial.</p>
<p>This tutorial references the following APIs:</p><ul>
<li><a class="el" href="c_le_avdata.html">AirVantage Data API</a> API (le_avdata.api)</li>
</ul>
<h1><a class="anchor" id="avExchangeData_define"></a>
Data Create the App</h1>
<p>This section covers how to define App data and configure variables, settings, and commands.</p>
<p>First, define a scenario to implement and describe the data to be exchanged. Once this has been designed it needs to be implemented inside the main source code of your App.</p>
<h2><a class="anchor" id="avExchangeData_defineData_one"></a>
One Room Scenario</h2>
<p>This sample shows how to use AirVantage to automate remote monitoring and control of scenario for simple room temperature:</p>
<p>In this model, one Room has 3 variables that can be read (no write access) by AirVantage:</p><ul>
<li>Room name</li>
<li>Current temperature</li>
<li>Current AC switch (on/off) state</li>
</ul>
<p>The Room also has 1 target temperature setting that a user can remotely get/set (read/write) from AirVantage.</p>
<p>The Room also has an AC switch which can be turned off via an AirVantage command, if the user wishes to turn on the AC they need to do this by setting the target temperature.</p>
<p>The variables, setting and commands are defined as Linux path, which can be stored in the macro definition.</p>
<pre class="fragment"><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Declare asset data path</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"> </div><div class="line"><span class="comment">/* variables */</span></div><div class="line"><span class="comment">// string - room name</span></div><div class="line"><span class="preprocessor">#define ROOM_NAME_VAR_RES   "/home1/room1/roomName"</span></div><div class="line"> </div><div class="line"><span class="comment">// bool - status of air conditioning in the room ON or OFF</span></div><div class="line"><span class="preprocessor">#define IS_AC_ON_VAR_RES   "/home1/room1/AC/IsACOn"</span></div><div class="line"> </div><div class="line"><span class="comment">// float - room temperature reading</span></div><div class="line"><span class="preprocessor">#define ROOM_TEMP_READING_VAR_RES "/home1/room1/thermostat/roomTemp"</span></div><div class="line"> </div><div class="line"><span class="comment">/* settings*/</span></div><div class="line"> </div><div class="line"><span class="comment">//float - target temperature setting</span></div><div class="line"><span class="preprocessor">#define TARGET_TEMP_SET_RES "/home1/room1/thermostat/targetTemp"</span></div><div class="line"> </div><div class="line"><span class="comment">/* commands */</span></div><div class="line"> </div><div class="line"><span class="comment">// commands to turn off the air conditioning</span></div><div class="line"><span class="preprocessor">#define AC_CMD_TURN_OFF_RES              "/home1/room1/AC/ACControl"</span></div></pre><!-- fragment --> <h1><a class="anchor" id="avExchangeData_implementLegatoApp"></a>
Implement Legato App</h1>
<p>This section covers how to:</p><ul>
<li>get Legato <a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp_sampleCode">Sample Source Code</a> from GitHub</li>
<li><a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp_useAPIs">Use Legato APIs</a>.</li>
<li><a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp_varSettings">Declare variables</a>.</li>
<li><a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp_initApp">Initialize App</a>.</li>
<li><a class="el" href="avExchangeData.html#avExchangeData_implementLegatoApp_compileInstall">Compile and Install</a> App</li>
</ul>
<h2><a class="anchor" id="avExchangeData_implementLegatoApp_sampleCode"></a>
Sample Source Code</h2>
<p>Download the <a href="https://github.com/legatoproject/legato-af/tree/master/apps/sample/assetData">sample app source code</a> from GitHub.</p>
<p>Before data exchange can start with AirVantage, a LWM2M session must be established, this is taken care of by the sample app.</p>
<p>Start an AVC Session:</p>
<pre class="fragment"><div class="line"><a class="code" href="le__event_loop_8h.html#abdb9187a56836a93d19cc793cbd4b7ec">COMPONENT_INIT</a></div><div class="line">{</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Start Legato AssetDataApp"</span>);</div><div class="line"> </div><div class="line">    <a class="code" href="le__signals_8h.html#a095ec12deab6b6ed0475583586a6c4d7">le_sig_Block</a>(SIGTERM);</div><div class="line">    <a class="code" href="le__signals_8h.html#a421910132f193dae70e8309dc86a86c4">le_sig_SetEventHandler</a>(SIGTERM, sig_appTermination_cbh);</div><div class="line"> </div><div class="line">    <span class="comment">//Start AVC Session</span></div><div class="line">    <span class="comment">//Register AVC handler</span></div><div class="line">    avcEventHandlerRef = <a class="code" href="le__avdata__interface_8h.html#af36e54289bb16f2f29da4c7456560982">le_avdata_AddSessionStateHandler</a>(avcStatusHandler, NULL);</div><div class="line">    <span class="comment">//Request AVC session. Note: AVC handler must be registered prior starting a session</span></div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a1a7e4c61c7b1e5a157428da7c60e1024">le_avdata_RequestSessionObjRef_t</a> sessionRequestRef = <a class="code" href="le__avdata__interface_8h.html#a1153ba43d55c59db3d36e3f44fd5ff10">le_avdata_RequestSession</a>();</div><div class="line">    <span class="keywordflow">if</span> (NULL == sessionRequestRef)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"AirVantage Connection Controller does not start."</span>);</div><div class="line">    }<span class="keywordflow">else</span>{</div><div class="line">        sessionRef=sessionRequestRef;</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"AirVantage Connection Controller started."</span>);</div><div class="line">    }</div></pre><!-- fragment --> <h2><a class="anchor" id="avExchangeData_implementLegatoApp_useAPIs"></a>
Use Legato APIs</h2>
<p><a class="el" href="c_le_avdata.html">AirVantage Data API</a> API (le_avdata.api) contains functions to create a LWM2M session as well as sending and receiving data with AirVantage.</p>
<p>In the <b>component definition</b> file <code>component.cdef:</code> </p><pre class="fragment"><div class="line">requires:</div><div class="line">{</div><div class="line">    api:</div><div class="line">    {</div><div class="line">        le_avdata.api</div><div class="line">    }</div><div class="line">}</div></pre><!-- fragment --><p>In the <b>app definition file</b>, <code>assetData.adef:</code> </p>
<pre class="fragment"><div class="line">bindings:</div><div class="line">{</div><div class="line">    assetData.componentAssetData.le_avdata -&gt; avcService.le_avdata</div><div class="line">}</div></pre><!-- fragment --><p>The make file contains the following commands to create the assetData App:</p>
<p>In the <b>Makefile:</b> </p><pre class="fragment"><div class="line">mkapp -v -t $@ assetData.adef</div></pre><!-- fragment --><p>The main code handling the app data exchange with AirVantage is in <code>main.c</code> </p>
<h2><a class="anchor" id="avExchangeData_implementLegatoApp_varSettings"></a>
Declare Variables</h2>
<p>Let's declare the following as global:</p>
<pre class="fragment"><div class="line"><span class="preprocessor">#define APP_RUNNING_DURATION_SEC 600        //run this app for 10min</span></div><div class="line"><span class="comment">// [AssetDataPath]</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Declare asset data path</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"> </div><div class="line"><span class="comment">/* variables */</span></div><div class="line"><span class="comment">// string - room name</span></div><div class="line"><span class="preprocessor">#define ROOM_NAME_VAR_RES   "/home1/room1/roomName"</span></div><div class="line"> </div><div class="line"><span class="comment">// bool - status of air conditioning in the room ON or OFF</span></div><div class="line"><span class="preprocessor">#define IS_AC_ON_VAR_RES   "/home1/room1/AC/IsACOn"</span></div><div class="line"> </div><div class="line"><span class="comment">// float - room temperature reading</span></div><div class="line"><span class="preprocessor">#define ROOM_TEMP_READING_VAR_RES "/home1/room1/thermostat/roomTemp"</span></div><div class="line"> </div><div class="line"><span class="comment">/* settings*/</span></div><div class="line"> </div><div class="line"><span class="comment">//float - target temperature setting</span></div><div class="line"><span class="preprocessor">#define TARGET_TEMP_SET_RES "/home1/room1/thermostat/targetTemp"</span></div><div class="line"> </div><div class="line"><span class="comment">/* commands */</span></div><div class="line"> </div><div class="line"><span class="comment">// commands to turn off the air conditioning</span></div><div class="line"><span class="preprocessor">#define AC_CMD_TURN_OFF_RES              "/home1/room1/AC/ACControl"</span></div><div class="line"><span class="comment">// [AssetDataPath]</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * AVC related variable and update timer</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// reference timer for app session</span></div><div class="line"><a class="code" href="le__timer_8h.html#a763fa6992488cdce3b5a820817094838">le_timer_Ref_t</a> sessionTimer;</div><div class="line"><span class="comment">//reference to AVC event handler</span></div><div class="line"><a class="code" href="le__avdata__interface_8h.html#a99a6853bdf4144b6c47331d2d69adedf">le_avdata_SessionStateHandlerRef_t</a>  avcEventHandlerRef = NULL;</div><div class="line"><span class="comment">//reference to AVC Session handler</span></div><div class="line"><a class="code" href="le__avdata__interface_8h.html#a1a7e4c61c7b1e5a157428da7c60e1024">le_avdata_RequestSessionObjRef_t</a> sessionRef = NULL;</div><div class="line"><span class="comment">//reference to temperature update timer</span></div><div class="line"><a class="code" href="le__timer_8h.html#a763fa6992488cdce3b5a820817094838">le_timer_Ref_t</a> tempUpdateTimerRef = NULL;</div><div class="line"><span class="comment">//reference to push asset data timer</span></div><div class="line"><a class="code" href="le__timer_8h.html#a763fa6992488cdce3b5a820817094838">le_timer_Ref_t</a> serverUpdateTimerRef = NULL;</div><div class="line"> </div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Counters recording the number of times certain hardwares are accessed.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> ReadTempVarCounter = 0;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> WriteTempSettingCounter = 0;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> ExecACCmd = 0;</div><div class="line"> </div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Target temperature related declarations.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* RoomNameVar;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span> RoomTempVar = 0.0;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> TargetTempSet = 0;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> IsACOn = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> OutsideTemp = 30;</div><div class="line"> </div></pre><!-- fragment --> <h2><a class="anchor" id="avExchangeData_implementLegatoApp_initApp"></a>
Initialize App</h2>
<p>The <code>COMPONENT_INIT</code> is called <b>once</b> by the Legato framework when the App starts. This is where your component's initialization code goes.</p>
<p><code>COMPONENT_INIT</code> must return to the framework. App logic tasks are implemented outside of this function using event-handlers: an event-driven model App.</p>
<h3><a class="anchor" id="avExchangeData_implementLegatoApp_COMPONENT_INIT"></a>
COMPONENT_INIT</h3>
<p>We'll do the following initializations in COMPONENT_INIT:</p>
<p><b>Register an AirVantage Controller (AVC) handler</b> function, by calling <a class="el" href="le__avdata__interface_8h.html#af36e54289bb16f2f29da4c7456560982">le_avdata_AddSessionStateHandler()</a> function. Only a registered control App can call <a class="el" href="le__avdata__interface_8h.html#a1153ba43d55c59db3d36e3f44fd5ff10">le_avdata_RequestSession()</a>.</p>
<p><b>Call</b> <a class="el" href="le__avdata__interface_8h.html#a1153ba43d55c59db3d36e3f44fd5ff10">le_avdata_RequestSession()</a> to start an AVC Session with AirVantage.</p>
<pre class="fragment"><div class="line"><a class="code" href="le__event_loop_8h.html#abdb9187a56836a93d19cc793cbd4b7ec">COMPONENT_INIT</a></div><div class="line">{</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Start Legato AssetDataApp"</span>);</div><div class="line"> </div><div class="line">    <a class="code" href="le__signals_8h.html#a095ec12deab6b6ed0475583586a6c4d7">le_sig_Block</a>(SIGTERM);</div><div class="line">    <a class="code" href="le__signals_8h.html#a421910132f193dae70e8309dc86a86c4">le_sig_SetEventHandler</a>(SIGTERM, sig_appTermination_cbh);</div><div class="line"> </div><div class="line">    <span class="comment">//Start AVC Session</span></div><div class="line">    <span class="comment">//Register AVC handler</span></div><div class="line">    avcEventHandlerRef = <a class="code" href="le__avdata__interface_8h.html#af36e54289bb16f2f29da4c7456560982">le_avdata_AddSessionStateHandler</a>(avcStatusHandler, NULL);</div><div class="line">    <span class="comment">//Request AVC session. Note: AVC handler must be registered prior starting a session</span></div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a1a7e4c61c7b1e5a157428da7c60e1024">le_avdata_RequestSessionObjRef_t</a> sessionRequestRef = <a class="code" href="le__avdata__interface_8h.html#a1153ba43d55c59db3d36e3f44fd5ff10">le_avdata_RequestSession</a>();</div><div class="line">    <span class="keywordflow">if</span> (NULL == sessionRequestRef)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"AirVantage Connection Controller does not start."</span>);</div><div class="line">    }<span class="keywordflow">else</span>{</div><div class="line">        sessionRef=sessionRequestRef;</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"AirVantage Connection Controller started."</span>);</div><div class="line">    }</div></pre><!-- fragment --><p> <b>Create a timer to close the AVC session</b> and exit app, in 10 min:</p>
<pre class="fragment"><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Started LWM2M session with AirVantage"</span>);</div><div class="line">    sessionTimer = <a class="code" href="le__timer_8h.html#aee41169a210378b369f440cf99146522">le_timer_Create</a>(<span class="stringliteral">"AssetDataAppSessionTimer"</span>);</div><div class="line">    <a class="code" href="structle__clk___time__t.html">le_clk_Time_t</a> avcInterval = {APP_RUNNING_DURATION_SEC, 0};</div><div class="line">    <a class="code" href="le__timer_8h.html#a0a103d5cef5e83fc9088859d527bbd43">le_timer_SetInterval</a>(sessionTimer, avcInterval);</div><div class="line">    <a class="code" href="le__timer_8h.html#a292b0a7d6dc0796a36a54fd04c6a7eeb">le_timer_SetRepeat</a>(sessionTimer, 1);</div><div class="line">    <a class="code" href="le__timer_8h.html#a8fb341f11e0da2692453df997613cb8e">le_timer_SetHandler</a>(sessionTimer, timerExpiredHandler);</div><div class="line">    <a class="code" href="le__timer_8h.html#ada2ce7f8cb1e76ed959e323ae94bbfc0">le_timer_Start</a>(sessionTimer);</div></pre><!-- fragment --><p> <b>Create an instances of Room Asset</b>, by calling <a class="el" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource()</a></p>
<pre class="fragment"><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Create instances AssetData "</span>);</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultCreateRoomName;</div><div class="line">    resultCreateRoomName = <a class="code" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource</a>(ROOM_NAME_VAR_RES,<a class="code" href="le__avdata__interface_8h.html#a3b231b512ef7918ab579c943e2e684e2adfae7598cd52960a9183b42c339aacda">LE_AVDATA_ACCESS_VARIABLE</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultCreateRoomName)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in creating ROOM_NAME_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultCreateIsACOn;</div><div class="line">    resultCreateIsACOn = <a class="code" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource</a>(IS_AC_ON_VAR_RES,<a class="code" href="le__avdata__interface_8h.html#a3b231b512ef7918ab579c943e2e684e2adfae7598cd52960a9183b42c339aacda">LE_AVDATA_ACCESS_VARIABLE</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultCreateIsACOn)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in creating IS_AC_ON_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultCreateRoomTemp;</div><div class="line">    resultCreateRoomTemp = <a class="code" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource</a>(ROOM_TEMP_READING_VAR_RES,<a class="code" href="le__avdata__interface_8h.html#a3b231b512ef7918ab579c943e2e684e2adfae7598cd52960a9183b42c339aacda">LE_AVDATA_ACCESS_VARIABLE</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultCreateRoomTemp)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in creating ROOM_TEMP_READING_VAR_RES"</span>);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultCreateTargetTemp;</div><div class="line">    resultCreateTargetTemp = <a class="code" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource</a>(TARGET_TEMP_SET_RES,<a class="code" href="le__avdata__interface_8h.html#a3b231b512ef7918ab579c943e2e684e2a7d781f4de4c929bef48315b82e0ad548">LE_AVDATA_ACCESS_SETTING</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultCreateTargetTemp)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in creating TARGET_TEMP_SET_RES"</span>);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultCreateACCmd = <a class="code" href="le__avdata__interface_8h.html#a9adb41270f7420fd269606c12f0a7c4c">le_avdata_CreateResource</a>(AC_CMD_TURN_OFF_RES, <a class="code" href="le__avdata__interface_8h.html#a3b231b512ef7918ab579c943e2e684e2a288bd70aab5e0563c4b7128dec6d0235">LE_AVDATA_ACCESS_COMMAND</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultCreateACCmd)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in creating AC_CMD_TURN_OFF_RES"</span>);</div><div class="line">    }</div></pre><!-- fragment --><p> <b>Assign default values</b> to the room asset variables (declared as global variables):</p>
<pre class="fragment"><div class="line">    <span class="comment">//setting the variable initial value</span></div><div class="line">    TargetTempSet = 21;</div><div class="line">    RoomTempVar = 30.0;</div><div class="line">    RoomNameVar = <span class="stringliteral">"Room1"</span>;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetRoomName = <a class="code" href="le__avdata__interface_8h.html#ae0e512ce812aed3b52106d2b30a0ab54">le_avdata_SetString</a>(ROOM_NAME_VAR_RES, RoomNameVar);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetRoomName)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting ROOM_NAME_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetIsACOn = <a class="code" href="le__avdata__interface_8h.html#aebdf8945bb2f58d816811ed177f14c70">le_avdata_SetBool</a>(IS_AC_ON_VAR_RES, IsACOn);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetIsACOn)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting IS_AC_ON_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetRoomTemp = <a class="code" href="le__avdata__interface_8h.html#a6b66143f2c24e403f9ede1679cd2af31">le_avdata_SetFloat</a>(ROOM_TEMP_READING_VAR_RES,RoomTempVar);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetRoomTemp)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting ROOM_TEMP_READING_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetTargetTemp = <a class="code" href="le__avdata__interface_8h.html#a61bafefd7356193f1d3111cceb8db1ad">le_avdata_SetInt</a>(TARGET_TEMP_SET_RES,TargetTempSet);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetTargetTemp)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting TARGET_TEMP_SET_RES"</span>);</div><div class="line">    }</div></pre><!-- fragment --><p> <b>Register handler</b>, in order to apply Settings and Commands sent by AirVantage. For each data field (settings and commands), call <a class="el" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler()</a> to register handler functions that will be called by the framework whenever the field is altered by AirVantage:</p>
<pre class="fragment"><div class="line">    <span class="comment">//Register handler for Variables, Settings and Commands</span></div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Register handler of paths"</span>);</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler</a>(ROOM_TEMP_READING_VAR_RES, ReadTempVarHandler, NULL);</div><div class="line"> </div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler</a>(TARGET_TEMP_SET_RES,</div><div class="line">                                      TempSettingHandler, NULL);</div><div class="line"> </div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler</a>(AC_CMD_TURN_OFF_RES, ExecACCtrlCmd, NULL);</div></pre><!-- fragment --><p> <b>Create a timer to update the room temperature values</b> every 20 seconds:</p>
<pre class="fragment"><div class="line">    <span class="comment">//Set timer to update temperature on a regular basis</span></div><div class="line">    tempUpdateTimerRef = <a class="code" href="le__timer_8h.html#aee41169a210378b369f440cf99146522">le_timer_Create</a>(<span class="stringliteral">"tempUpdateTimer"</span>);     <span class="comment">//create timer</span></div><div class="line">    <a class="code" href="structle__clk___time__t.html">le_clk_Time_t</a> tempUpdateInterval = { 20, 0 };            <span class="comment">//update temperature every 20 seconds</span></div><div class="line">    <a class="code" href="le__timer_8h.html#a0a103d5cef5e83fc9088859d527bbd43">le_timer_SetInterval</a>(tempUpdateTimerRef, tempUpdateInterval);</div><div class="line">    <a class="code" href="le__timer_8h.html#a292b0a7d6dc0796a36a54fd04c6a7eeb">le_timer_SetRepeat</a>(tempUpdateTimerRef, 0);                   <span class="comment">//set repeat to always</span></div><div class="line">    <span class="comment">//set callback function to handle timer expiration event</span></div><div class="line">    <a class="code" href="le__timer_8h.html#a8fb341f11e0da2692453df997613cb8e">le_timer_SetHandler</a>(tempUpdateTimerRef, UpdateTemperature);</div><div class="line">    <span class="comment">//start timer</span></div><div class="line">    <a class="code" href="le__timer_8h.html#ada2ce7f8cb1e76ed959e323ae94bbfc0">le_timer_Start</a>(tempUpdateTimerRef);</div></pre><!-- fragment --><p> <b>Create a timer to push the values</b> to the server every 10 seconds:</p>
<pre class="fragment"><div class="line">    <span class="comment">//Set timer to update on server on a regular basis</span></div><div class="line">    serverUpdateTimerRef = <a class="code" href="le__timer_8h.html#aee41169a210378b369f440cf99146522">le_timer_Create</a>(<span class="stringliteral">"serverUpdateTimer"</span>);     <span class="comment">//create timer</span></div><div class="line">    <a class="code" href="structle__clk___time__t.html">le_clk_Time_t</a> serverUpdateInterval = { 10, 0 };            <span class="comment">//update server every 10 seconds</span></div><div class="line">    <a class="code" href="le__timer_8h.html#a0a103d5cef5e83fc9088859d527bbd43">le_timer_SetInterval</a>(serverUpdateTimerRef, serverUpdateInterval);</div><div class="line">    <a class="code" href="le__timer_8h.html#a292b0a7d6dc0796a36a54fd04c6a7eeb">le_timer_SetRepeat</a>(serverUpdateTimerRef, 0);                   <span class="comment">//set repeat to always</span></div><div class="line">    <span class="comment">//set callback function to handle timer expiration event</span></div><div class="line">    <a class="code" href="le__timer_8h.html#a8fb341f11e0da2692453df997613cb8e">le_timer_SetHandler</a>(serverUpdateTimerRef, PushResources);</div><div class="line">    <span class="comment">//start timer</span></div><div class="line">    <a class="code" href="le__timer_8h.html#ada2ce7f8cb1e76ed959e323ae94bbfc0">le_timer_Start</a>(serverUpdateTimerRef);</div></pre><!-- fragment --> <h3><a class="anchor" id="avExchangeData_implementLegatoApp_VariableHandlers"></a>
Variable Handler Functions</h3>
<p>This App has a variable handler function for <code>ROOM_TEMP_READING_VAR_RES</code> to count the number of server reads of the room temperature.</p>
<p>The function must be registered in <code>COMPONENT_INIT</code> with <a class="el" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler()</a>.</p>
<p>Let’s name it ReadTempVarHandler: </p><pre class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ReadTempVarHandler(<span class="keyword">const</span> <span class="keywordtype">char</span>* path,<a class="code" href="le__avdata__interface_8h.html#ad56a627b4d99bf00b58f3cd4638da3b5">le_avdata_AccessType_t</a> accessType,<a class="code" href="le__avdata__interface_8h.html#a56727dc1001c0fb19a04451c1f6c5ac9">le_avdata_ArgumentListRef_t</a> argumentList,<span class="keywordtype">void</span>* contextPtr)</div></pre><!-- fragment --><p>This function is called by the <code>avcServce</code> whenever AirVantage wants to read the room temperature:</p>
<pre class="fragment"><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Variable data handler.</span></div><div class="line"><span class="comment"> * This function is returned whenever AirVantage performs a read on the room's temperature</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ReadTempVarHandler</div><div class="line">(</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* path,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#ad56a627b4d99bf00b58f3cd4638da3b5">le_avdata_AccessType_t</a> accessType,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a56727dc1001c0fb19a04451c1f6c5ac9">le_avdata_ArgumentListRef_t</a> argumentList,</div><div class="line">    <span class="keywordtype">void</span>* contextPtr</div><div class="line">)</div><div class="line">{</div><div class="line">    ReadTempVarCounter++;</div><div class="line"> </div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"------------------- Server reads room temperature [%d] times ------------"</span>,</div><div class="line">            ReadTempVarCounter);</div><div class="line">}</div></pre><!-- fragment --> <h3><a class="anchor" id="avExchangeData_implementLegatoApp_setHandlers"></a>
Setting Handler Functions</h3>
<p>Our app needs to implement handler functions to retrieve the value of a Setting (<code>TargetTemperature</code>) set by AirVantage. It also counts the number of times the server has retrieved the value.</p>
<p>This function must be registered in COMPONENT_INIT with <a class="el" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler()</a>.</p>
<p>Let's name it TempSettingHandler, define a function that can be called by the avcService whenever AirVantage Server receives a request to change the path:</p>
<pre class="fragment"></pre><!-- fragment --><p> To retrieve the value pushed by AirVantage, call <a class="el" href="le__avdata__interface_8h.html#a006ab36c1a32254dc1c3b2608f7d1c83">le_avdata_GetInt()</a> | <a class="el" href="le__avdata__interface_8h.html#a2e1b407f6bff2f1b6d6e76e014e71341">le_avdata_GetFloat()</a> | <a class="el" href="le__avdata__interface_8h.html#a084dee5b151d80c1b41f34a4a10f8f5a">le_avdata_GetBool()</a> | <a class="el" href="le__avdata__interface_8h.html#a60804210f96415dea3fa6607f6f2937b">le_avdata_GetString()</a>.</p>
<p>Example: </p><pre class="fragment"><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Setting data handler.</span></div><div class="line"><span class="comment"> * This function is returned whenever AirVantage performs a read or write on the target temperature</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// [TempSettingHandler]</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> TempSettingHandler</div><div class="line">(</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* path,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#ad56a627b4d99bf00b58f3cd4638da3b5">le_avdata_AccessType_t</a> accessType,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a56727dc1001c0fb19a04451c1f6c5ac9">le_avdata_ArgumentListRef_t</a> argumentList,</div><div class="line">    <span class="keywordtype">void</span>* contextPtr</div><div class="line">)</div><div class="line"><span class="comment">// TempSettingHandler</span></div><div class="line">{</div><div class="line">    WriteTempSettingCounter++;</div><div class="line"> </div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"------------------- Server writes temperature setting [%d] times ------------"</span>,</div><div class="line">                WriteTempSettingCounter);</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultGetInt = <a class="code" href="le__avdata__interface_8h.html#a006ab36c1a32254dc1c3b2608f7d1c83">le_avdata_GetInt</a>(TARGET_TEMP_SET_RES, &amp;TargetTempSet);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultGetInt)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in getting latest TARGET_TEMP_SET_RES"</span>);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// turn on the air conditioning if room temperature is higher than target temperature</span></div><div class="line">    <span class="keywordflow">if</span> (TargetTempSet &lt; RoomTempVar)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetAC = <a class="code" href="le__avdata__interface_8h.html#aebdf8945bb2f58d816811ed177f14c70">le_avdata_SetBool</a>(IS_AC_ON_VAR_RES, <span class="keyword">true</span>);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetAC)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting IS_AC_ON_VAR_RES"</span>);</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Setting Write turning on AC variable request: %s"</span>, <span class="stringliteral">"IS_AC_ON_VAR_RES"</span>);</div><div class="line">    }<span class="keywordflow">else</span>{</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultSetAC = <a class="code" href="le__avdata__interface_8h.html#aebdf8945bb2f58d816811ed177f14c70">le_avdata_SetBool</a>(IS_AC_ON_VAR_RES, <span class="keyword">true</span>);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultSetAC)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting IS_AC_ON_VAR_RES"</span>);</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Setting Write turning on AC variable request: %s"</span>, <span class="stringliteral">"IS_AC_ON_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">}</div></pre><!-- fragment --> <h3><a class="anchor" id="avExchangeData_implementLegatoApp_cmdHandlers"></a>
Command Handler Functions</h3>
<p>Our App needs to implement handler function to Execute the Command (<code>AC_CMD_TURN_OFF_RES</code>) set by AirVantage. The App also changes IS_AC_ON_VAR_RES to false.</p>
<p>This function must be registered in COMPONENT_INIT with <a class="el" href="le__avdata__interface_8h.html#adaf94585417ad8cf04efc890e1509f1f">le_avdata_AddResourceEventHandler()</a>.</p>
<p>Let's name it ExecACCtrlCmd:</p>
<pre class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ExecACCtrlCmd</div><div class="line">(</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* path,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#ad56a627b4d99bf00b58f3cd4638da3b5">le_avdata_AccessType_t</a> accessType,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a56727dc1001c0fb19a04451c1f6c5ac9">le_avdata_ArgumentListRef_t</a> argumentList,</div><div class="line">    <span class="keywordtype">void</span>* contextPtr</div><div class="line">)</div></pre><!-- fragment --><p> This function will be called by the <code>avcService</code> whenever AirVantage wants to execute the <code>ExecACCtrlCmd</code> command on <code>AC_CMD_TURN_OFF_RES</code>.</p>
<pre class="fragment"><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Command data handler.</span></div><div class="line"><span class="comment"> * This function is returned whenever AirVantage performs an execute on the AC turn off command</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// [VariableExectACCtrlCmd]</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ExecACCtrlCmd</div><div class="line">(</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* path,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#ad56a627b4d99bf00b58f3cd4638da3b5">le_avdata_AccessType_t</a> accessType,</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a56727dc1001c0fb19a04451c1f6c5ac9">le_avdata_ArgumentListRef_t</a> argumentList,</div><div class="line">    <span class="keywordtype">void</span>* contextPtr</div><div class="line">)</div><div class="line"><span class="comment">// [VariableExectACCtrlCmd]</span></div><div class="line">{</div><div class="line">    ExecACCmd++;</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"------------------- Exec AC Commnad [%d] times ------------"</span>,</div><div class="line">                ExecACCmd);</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> setACVAR = <a class="code" href="le__avdata__interface_8h.html#aebdf8945bb2f58d816811ed177f14c70">le_avdata_SetBool</a>(IS_AC_ON_VAR_RES,<span class="keyword">false</span>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == setACVAR)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error in setting IS_AC_ON_VAR_RES"</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Command exec turning off AC variable request: %s"</span>, <span class="stringliteral">"IS_AC_ON_VAR_RES"</span>);</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keywordtype">double</span> ConvergeTemperature(<span class="keywordtype">double</span> currentTemperature, <span class="keywordtype">int</span> targetTemperature)</div><div class="line">{</div><div class="line">    <span class="keywordtype">double</span> fTargetTemp = (double) targetTemperature;</div><div class="line"> </div><div class="line">    <span class="keywordflow">if</span> (currentTemperature == fTargetTemp)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> fTargetTemp;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keywordtype">double</span> fStep = 0.2;</div><div class="line"> </div><div class="line">    <span class="keywordflow">if</span> (currentTemperature &gt; fTargetTemp)</div><div class="line">    {</div><div class="line">        currentTemperature -= fStep;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        currentTemperature += fStep;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> currentTemperature;</div><div class="line">}</div></pre><!-- fragment --><h3><a class="anchor" id="avExchangeData_implementLegatoApp_avcHandler"></a>
AVC Handler Functions</h3>
<p>The <code>avcStatusHandler</code> function has been registered in the COMPONENT_INIT function by using <code><a class="el" href="le__avdata__interface_8h.html#af36e54289bb16f2f29da4c7456560982">le_avdata_AddSessionStateHandler()</a></code>; this is required to start LWM2M session with AirVantage. For this tutorial the variable: <code>updateStatus</code> is compared with the AVC Status.</p>
<h2><a class="anchor" id="avExchangeData_implementLegatoApp_pushHandler"></a>
Push Data from Target to AirVantage</h2>
<p>The PushResources function will push the Resources to the AirVantage Cloud at regular intervals (defined by the timer). Once data is pushed to AirVantage you can log into the UI and view the resources.</p>
<pre class="fragment"><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Push ack callback handler</span></div><div class="line"><span class="comment"> * This function is called whenever push has been performed successfully in AirVantage server</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> PushCallbackHandler</div><div class="line">(</div><div class="line">    <a class="code" href="le__avdata__interface_8h.html#a03e16db57b2114699db0700c32e7bb78">le_avdata_PushStatus_t</a> status,</div><div class="line">    <span class="keywordtype">void</span>* contextPtr</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="le__avdata__interface_8h.html#a03e16db57b2114699db0700c32e7bb78ade234d16bd1731de5b7193b35b6a42bb">LE_AVDATA_PUSH_SUCCESS</a>:</div><div class="line">            <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Legato assetdata push successfully"</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="le__avdata__interface_8h.html#a03e16db57b2114699db0700c32e7bb78a87005ec83cd0cbf736538a3826016663">LE_AVDATA_PUSH_FAILED</a>:</div><div class="line">            <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Legato assetdata push failed"</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Push ack callback handler</span></div><div class="line"><span class="comment"> * This function is called every 10 seconds to push the data and update data in AirVantage server</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//-------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> PushResources(<a class="code" href="le__timer_8h.html#a763fa6992488cdce3b5a820817094838">le_timer_Ref_t</a>  timerRef)</div><div class="line">{</div><div class="line">    <span class="comment">// if session is still open, push the values</span></div><div class="line">    <span class="keywordflow">if</span> (NULL != avcEventHandlerRef)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultPushRoomName;</div><div class="line">        resultPushRoomName = <a class="code" href="le__avdata__interface_8h.html#a29358516371baeb8a3c3b03e5d2bd4ec">le_avdata_Push</a>(ROOM_NAME_VAR_RES, PushCallbackHandler, NULL);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultPushRoomName)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error pushing ROOM_NAME_VAR_RES"</span>);</div><div class="line">        }</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultPushACStatus;</div><div class="line">        resultPushACStatus = <a class="code" href="le__avdata__interface_8h.html#a29358516371baeb8a3c3b03e5d2bd4ec">le_avdata_Push</a>(IS_AC_ON_VAR_RES, PushCallbackHandler, NULL);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultPushACStatus)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error pushing IS_AC_ON_VAR_RES"</span>);</div><div class="line">        }</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultPushRoomTemp;</div><div class="line">        resultPushRoomTemp = <a class="code" href="le__avdata__interface_8h.html#a29358516371baeb8a3c3b03e5d2bd4ec">le_avdata_Push</a>(ROOM_TEMP_READING_VAR_RES, PushCallbackHandler, NULL);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultPushRoomTemp)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error pushing ROOM_TEMP_READING_VAR_RES"</span>);</div><div class="line">        }</div><div class="line">        <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> resultPushTargetTemp;</div><div class="line">        resultPushTargetTemp = <a class="code" href="le__avdata__interface_8h.html#a29358516371baeb8a3c3b03e5d2bd4ec">le_avdata_Push</a>(TARGET_TEMP_SET_RES, PushCallbackHandler, NULL);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a> == resultPushTargetTemp)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Error pushing TARGET_TEMP_SET_RES"</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre><!-- fragment --><p> Once the app is installed and running on your target, you should be able to see the resources in the AirVantage UI:</p>
<p>Location: "Monitor", "System", Click on your target device, Click "Timeline"</p>
<p>You will then see a list of communication that has been done between AirVantage and your Target.</p>
<p>Click on the "LWM2M" object to see the details.</p>
<div class="image">
<img alt="avExchangeData-resources.png" src="avExchangeData-resources.png"/>
</div>
<h3><a class="anchor" id="avExchangeData_implementLegatoApp_exitApp"></a>
Exit App</h3>
<p>The handler <code>timerExpiredHandler</code> is called by the avcService 10min later, as set in <code>COMPONENT_INIT</code>. This function closes LWM2M session and Quits the App.</p>
<h2><a class="anchor" id="avExchangeData_implementLegatoApp_compileInstall"></a>
Compile and Install</h2>
<p>Next, you have to compile your App and install it on the target device.</p>
<p>Compile the source code from <code>assetData</code> main folder and install the App on the target device.</p>
<p>Our example uses a mangOH board with an embedded WP8548 module so the compiler target will be <code>wp85</code>. If you're using a different target module, change the compiler target as needed (e.g., ar7, wp7 or ar86).</p>
<p>Run <code>bin/legs</code> and <code>cd</code> to the directory for the <code>assetData</code> sample App.</p>
<pre class="fragment">$ bin/legs
$ cd $LEGATO_ROOT/apps/sample/assetData
</pre><p>Next use  to build the sample App for your target.</p>
<pre class="fragment">$ make wp85
</pre><p>After <code>make</code> completes, a software package will be generated: <code>assetData.wp85.update</code> Use the <a class="el" href="toolsHost_update.html">update</a> tool to transfer the App to your target.</p>
<pre class="fragment">$ update assetData.wp85.update &lt;device_ip_address&gt;
</pre><p>We're now ready to started the App and "Exchange Data" with the AirVantage Server.</p>
<p>Open Logging and Start the app:</p>
<p>Open 2 terminals to the target by</p><pre class="fragment"><div class="line">ssh root@192.168.2.2 </div></pre><!-- fragment --><p>In the 1st terminal (to continuously view the logs): </p><pre class="fragment"># logread -f | grep "assetdata"
</pre><p>In the 2nd terminal (to start the app): </p><pre class="fragment"># app status   # check that assetData is listed
# app start assetData
</pre><p>In the 1st terminal you should see logging statements like: </p><pre class="fragment"># logread -f | grep "Legato AssetData: "
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c _assetDataComponent_COMPONENT_INIT() 297 | Legato AssetData: Start Legato AssetDataApp
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c _assetDataComponent_COMPONENT_INIT() 304 | Legato AssetData: AirVantage Connection Controller started.
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c _assetDataComponent_COMPONENT_INIT() 313 | Legato AssetData: Started LWM2M session with AirVantage
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c _assetDataComponent_COMPONENT_INIT() 323 | Legato AssetData: Create instances AssetData
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c _assetDataComponent_COMPONENT_INIT() 342 | Legato AssetData: Register handler of instances
Jul 28 22:59:52 swi-mdm9x15 user.info Legato:  INFO | assetData[18578]/assetDataComponent T=main | main.c avcStatusHandler() 277 | Legato AssetData: AirVantage agent reported update status: CONNECTION_REQUIRED
</pre><h1><a class="anchor" id="avExchangeData_exchData"></a>
Exchange Data with AirVantage</h1>
<p>The LightWeight M2M protocol default behavior initiates communication to the server through the target device. Once a connection between the server and the device is established, the server can send any request to the device: read or write a data, execute a command, apply a firmware upgrade, install an app, etc.</p>
<div class="image">
<img alt="lwm2m_communication.png" src="lwm2m_communication.png"/>
</div>
<p>When a device is in the field:</p><ul>
<li>On the first boot, it starts to communicate with the bootstrap server to collect credentials and the AirVantage URL. It will only do this if AirVantage denies the connection or at a regular interval to change the security keys (steps 1 and 2).</li>
<li>Then the device initiates a communication with AirVantage, updates the objects list (step 3).</li>
<li>AirVantage sends the pending requests to the device (step 4).</li>
<li>The device executes the requests.</li>
<li>The device communicates the acknowledgments and close the connection.</li>
</ul>
<h2><a class="anchor" id="avExchangeData_exchData_pushData"></a>
Push Data</h2>
<p>If you need to collect data as soon as the device is ready to communicate with AirVantage, and at high frequency, use <a class="el" href="le__avdata__interface_8h.html#a29358516371baeb8a3c3b03e5d2bd4ec">le_avdata_Push()</a>. When a new value is obtained from the sensor, the value is pushed to Legato. The target device sends the data automatically without a new request from AirVantage.</p>
<h1><a class="anchor" id="avExchangeData_avAPI"></a>
Testing Asset Data App Results</h1>
<p>AirVantage provides REST APIs to communicate with the AirVantage Server and interact with the variables, settings and commands. See <a href="https://source.sierrawireless.com/airvantage/av/reference/cloud/API/">AirVantage Web Services Documentation</a> for the API documentation used to communicate with the AirVantage Server.</p>
<p>This tutorial will walk you through setting up a connection to AirVantage using the REST APIs with <code>curl</code> library (installed when you set up Legato AF on your dev machine) to test out the Asset Data App that we just walked you through. You are welcome to use any REST API app to test.</p>
<h2><a class="anchor" id="avExchangeData_avAPI_Authenticate"></a>
Request Access Token</h2>
<p>Before you can send any requests you must first request an Authentication Token from the AirVantage Server.</p>
<p><code>1</code>. Log in to the AirVantage Web UI: <a href="https://eu.airvantage.net">Europe</a>.</p>
<p><code>2</code>. Click on "Develop", "API clients"</p>
<p><code>3</code>. Click "Create". Walk through the wizard and provide the required information. This will generate a client ID and secret key that you need to use with all your subsequent requests.</p>
<p>Once you've gotten the client ID and secret key you will need to make a request to AirVantage to obtain an access token.</p>
<pre class="fragment">server="https://eu.airvantage.net"
login="&lt;AirVantage login&gt;"
password="&lt;AirVantage password&gt;"
client_id="&lt;client ID obtained from the step above&gt;"
client_secret="&lt;secret key obtained from step above&gt;"

curl -s "${server}/api/oauth/token?grant_type=password&amp;username=${login}&amp;password=${password}&amp;client_id=${client_id}&amp;client_secret=${client_secret}"
</pre><p>The response should looks like this:</p>
<pre class="fragment">{
  "access_token": "fe47d528-7414-4962-a7e6-ee6b82491f7a",      # copy the access token
  "refresh_token": "9b465388-c9e2-45d3-98d0-1a44a503ec40",
  "expires_in": 43199,
}
</pre><p>The access token will allow further authorization of other requests to the AirVantage Web Services API and will need to be used in subsequent requests. If the token expires it must be requested again before further calls can be made.</p>
<h2><a class="anchor" id="avExchangeData_avAPI_UID"></a>
Obtain the UID of your target</h2>
<p>You will also need to include the UID of your target into the requests made to the AirVantage Web Services.</p>
<p>To obtain your UID:</p>
<p><code>1</code>. Log in to the AirVantage Web UI: <a href="https://eu.airvantage.net">Europe</a></p>
<p><code>2</code>. Click "Monitor", then "Systems" and select your system</p>
<p><code>3</code>. The URL should contain the UID of your system (e.g., <a href="https://eu.airvantage.net/monitor/systems/systemDetails?uid=xxxx">https://eu.airvantage.net/monitor/systems/systemDetails?uid=xxxx</a> )</p>
<h2><a class="anchor" id="avExchangeData_avAPI_Read"></a>
Request Data</h2>
<p>Now that you have your Access Token and UID you can now send requests to the AirVantage Server to request data with a Read request.</p>
<p>Example read request: </p><pre class="fragment">server="https://eu.airvantage.net"
access_token="&lt;access token&gt;"                     # refer to the step above to get your access token
uid="&lt;UID&gt;"                                       # refer to the step above to get uid
resource="assetData.home.room1.AC.IsACOn"         # resource we want to read from the device


curl -X POST -s "${server}/api/v1/operations/systems/data/retrieve?&amp;access_token=${access_token}" -H 'Content-Type: application/json' -d "{\"systems\":{\"uids\":[\"${uid}\"]}, \"data\":[\"${resource}\"]}"
</pre><p>In the AirVantage UI you should be able to see the read data:</p>
<p>Location: "Monitor", "System", Click on your target device, Click "Timeline"</p>
<p>You will then see a list of communication that has been done between AirVantage and your Target.</p>
<p>Click on the "Retrieve System Data" object to see the details.</p>
<div class="image">
<img alt="avExchangeData-Read2.png" src="avExchangeData-Read2.png"/>
</div>
<h2><a class="anchor" id="avExchangeData_avAPI_Write"></a>
Apply Settings</h2>
<p>You can now send requests to the AirVantage Server to apply settings with a write request.</p>
<p>Example write request: </p><pre class="fragment">server="https://eu.airvantage.net"
access_token="&lt;access token&gt;"                              # refer to the step above to get your access token
uid="&lt;UID&gt;"                                                # refer to the step above to get uid
resource="assetData.home1.room1.thermostat.targetTemp"     # resource we want to write to
value="100"                                                # the value we want to write to the resource

curl -X POST -s "${server}/api/v1/operations/systems/settings?&amp;access_token=${access_token}" -H 'Content-Type: application/json' -d "{\"reboot\":false,\"systems\":{\"uids\":[\"${uid}\"]}, \"settings\":[{\"key\":\"${resource}\", \"value\": \" ${value} \" }]}"
</pre><p>In the AirVantage UI you should be able to see the read data:</p>
<p>Location: "Monitor", "System", Click on your target device, Click "Timeline"</p>
<p>You will then see a list of communication that has been done between AirVantage and your Target.</p>
<p>Click on the "Apply Setting" object to see the details.</p>
<div class="image">
<img alt="avExchangeData-Write2.png" src="avExchangeData-Write2.png"/>
</div>
<h2><a class="anchor" id="avExchangeData_avAPI_Command"></a>
Send a Command</h2>
<p>You can now send requests to the AirVantage Server to perform a command with a command request.</p>
<p>Example command request: </p><pre class="fragment">server="https://eu.airvantage.net"
access_token="&lt;access token&gt;"                              # refer to the step above to get your access token
uid="&lt;UID&gt;"                                                # refer to the step above to get uid
resource="assetData.home1.room1.AC.ACControl"              # resource we want to send a command to

curl -X POST -s "${server}/api/v1/operations/systems/command?&amp;access_token=${access_token}" -H 'Content-Type: application/json' -d "{\"systems\":{\"uids\":[\"${uid}\"]}, \"commandId\":\"${resource}\"}"
</pre><p>In the AirVantage UI you should be able to see the read data:</p>
<p>Location: "Monitor", "System", Click on your target device, Click "Timeline"</p>
<p>You will then see a list of communication that has been done between AirVantage and your Target.</p>
<p>Click on the "Send Command" object to see the details.</p>
<div class="image">
<img alt="avExchangeData-Command.png" src="avExchangeData-Command.png"/>
</div>
<p class="copyright">Copyright (C) Sierra Wireless Inc. </p>
</div></div>
<br clear="left"/>
</div>
</div>
<link href="resources/css/jqtree.css" rel="stylesheet" type="text/css"/>
<script src="resources/js/tree.jquery.js" type="text/javascript"></script>
<script src="resources/js/jquery.cookie.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<link href="resources/css/perfect-scrollbar.min.css" rel="stylesheet"/>
<script src="resources/js/perfect-scrollbar.jquery.min.js"></script>
</body>
</html>
