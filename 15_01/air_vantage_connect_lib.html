<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LEGATO: AirVantage Agent Connector library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="fonts.css" rel="stylesheet" type="text/css" />
<link href="legato.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link rel="icon" type="image/png" href="favicon.ico" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <img alt="Logo" src="legatoLogo.png"/>
    <div id="projectbrief">Simplifying IoT development</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('air_vantage_connect_lib.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AirVantage Agent Connector library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>API info is here: <a class="el" href="swi__airvantage_8h.html">swi_airvantage.h</a></p>
<p>The info here covers details on data connections with AirVantage.</p>
<h1><a class="anchor" id="avConnectOverview"></a>
Overview</h1>
<p>The AirVantage Agent Connector library provides access to the AirVantage M2M platform. The Agent consists of a library and process that communicate through a dedicated IPC channel, most commonly a socket.</p>
<p>Communication with the server includes buffering and consolidating data on the embedded side, flushing them to the server according to customizable policies, subscribing to server-side or hardware events and value changes, acknowledge management.</p>
<p>The Agent naturally reasons by assets: connections to it are associated with a given asset when established, events and notifications are dispatched by asset, etc. The Agent's logical assets might map one-to-one with physical assets connected to the physical device, but they don't have to. Within an asset, data are organized into tree paths, and it is possible to subscribe to data or event limited to any arbitrary sub-path.</p>
<p>As a general principle, the Agent takes responsibility for the data that have been passed to it: it is in charge of optimizing their encoding and regrouping, of handling acknowledgements, of securing them in non-volatile memory if asked to, etc.</p>
<h1><a class="anchor" id="NewInstance"></a>
Create a New Asset Instance, Initialize a New Asset</h1>
<p>Creating a new asset is as simple as calling <code>swi_av_asset_Create</code> with a mandatory asset id string. It returns an AirVantage asset object, which acts on behalf of the asset.</p>
<p>An asset does not necessarily represent a physical piece of hardware; it is merely a representation of the global application architecture.</p>
<p>At this point, the asset is created but is not ready to communicate with the Agent. To make it active, the <code>swi_av_asset_Start</code> method must be called first, after any required event subscription has been performed.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="swi__airvantage_8h.html">swi_airvantage.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> airvantage_sample(){</div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a> *asset = NULL;    </div>
<div class="line">    <span class="comment">// configure the library, establish connection with the agent</span></div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#a22b561de348628ee35ce54f8a9efd8b4">swi_av_Init</a>();</div>
<div class="line">    <span class="comment">// create asset</span></div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#a41d12a618696657cb8487316b7139ddd">swi_av_asset_Create</a>(&amp;asset, <span class="stringliteral">&quot;house&quot;</span>);</div>
<div class="line">    <span class="comment">// register asset</span></div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#a5805cec0a0fb09df60324657c6159eba">swi_av_asset_Start</a>(asset);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The asset identifier is the root element of the message path. For instance, if the variable "foo" is written under path "bar" in the asset "myAsset", the complete path as seen by the server is "myAsset.bar.foo".</p>
<h1><a class="anchor" id="SendingData"></a>
Sending Data</h1>
<p>Data can be sent with two different APIs:</p>
<ul>
<li>Through pre-declared tables, where the user can specify the table's persistence mode, columns, serialization options, etc.</li>
<li>Directly, by passing data in a C parameter. This is the most flexible way in terms of what can be sent, but it does not allow you to customize storage and emission settings.</li>
</ul>
<p><b>Why policies?</b></p>
<p>Policies introduce an indirection in the way data are flushed from the agent to the server. This indirection is extremely precious over the lifetime of an M2M application: policies can be changed remotely, by asking the server to update the agent's configuration. If data triggering were done explicitly by the application, adapting the reporting policy to changing conditions (bandwidth congestion and billing, change in usage patterns...) would require a full software update.</p>
<p>There are a couple of legitimate, very advanced cases where an application needs direct control over data sending policies, and this can be done by forcing the triggers on a manual-only policy. But it should be avoided in most reasonable use cases, and represents a liability for long term maintenance.</p>
<h2><a class="anchor" id="SendingEvents"></a>
Sending Event</h2>
<p>Noteworthy events are notified between the assets and the server by sending data. When designing an application, some conventions are taken about which paths represent "normal" data, and which ones will be used to represent events. The embedded application will subscribe to these paths and hook a proper handling function on them; symmetrically, the server will be configured to react to "event paths" by causing the appropriate notifications.</p>
<p>Both data sending APIs can be used (raw data or pre-declared tables). However, given the generally simple and immediate kind of data exchange suitable to event notifications, the raw data API will most often be the best choice.</p>
<h2><a class="anchor" id="SendPolicies"></a>
Send Policies</h2>
<p>Data is not normally sent to the server as soon as the user requests it. It is accumulated by the Agent to limit the number of connections, to optimize their encoding, and optionally to perform some data consolidation operations on them. Data emission is performed according to a policy, which can be:</p>
<ul>
<li><code>cron="cron_config"</code>: The operation is performed at predefined dates, specified using the standard Unix cron syntax.</li>
<li><code>latency=n</code>: The operation will be performed in <code>n</code> seconds at most.</li>
<li><code>manual=true</code>: The connection will be triggered by the application through an explicit call to <code><a class="el" href="swi__airvantage_8h.html#afa0b2e621845620265508da88d0bfd48">swi_av_TriggerPolicy()</a></code>.</li>
<li><code>onboot=n</code>: The operation will be performed <code>n</code> seconds after the agent has been initialized.</li>
</ul>
<p>There can be multiple policies set up on a single device, and AirVantage APIs allow to choose according to which policy when each data is sent.</p>
<p><b>Policy Examples</b></p>
<p>If <code>cron="*"</code>, the device will connect at the beginning of every hour if there is something to send. Even if a connection is forced at 8:59, the cron connection will still be forced at 9:00.</p>
<p>If <code>latency=60*60</code>, the device will connect every one hour: the first connection will be done one hour after the device booted. However, if a periodic connection is due at 9:00, and a connection is forced at 8:59, the next connection will occur at 9:59 rather than at 9:00. This policy guarantees that data will not be buffered for more than 60*60 seconds before being sent to the server, and that no more than 60*60 seconds will pass between two connections. (Connections not only allow data to be sent to the server, but also to receive data sent by it).</p>
<p><code>onboot=n</code> policy rules are mostly useful if some unsent, persisted data might have been left unsent before a reboot. With such a policy, data unsent because of a shutdown will be sent when the device reboots.</p>
<p><b>Policy Configurations</b></p>
<p>To allow the handling of several policies, policy queues can be declared, in unlimited number, in the agent's configuration. They are indexed by name in <code>"data.policy"</code>, and contain a table with one key and one value. The key is one of <code>"cron", "latency", "manual"</code>. More than one pair can be given for a single policy.</p>
<ul>
<li>cron policies are triggered at predefined dates, which can be described with the same formalism as POSIX' cron task scheduler;</li>
<li>latency policies are guaranteed to be triggered before a given delay in seconds elapses. The delay, when non-zero, leaves a chance to group several triggerings together and to save some bandwidth;</li>
<li>manual policies are only triggered when the user application explicitly triggers them.</li>
</ul>
<p>Some policies must exist and have certain properties:</p>
<ul>
<li><code>"default"</code> is the policy chosen when a data sending command is given with no explicit policy. Users can change the way this policy is triggered.</li>
<li><code>"never"</code> cannot be triggered: data associated with this policy are never sent.</li>
<li><code>"now"</code> is intended for data which are to be sent (almost) immediately. It must be configured to be sent with a latency, and in normal situations, this latency should be short, no more than a couple of seconds.</li>
</ul>
<h2><a class="anchor" id="PolicyConfigSamples"></a>
Policy Config Samples</h2>
<p>Please note that even though basic knowledge on data policies is advised to correctly use AirVantage API, the policy configuration (creation/modification) demonstrated in this very section is optional. In basic use cases, using the default policies as provided by the agent will fulfill the needs.</p>
<p>There are several ways to access the Agent configuration: you can change the provisioning configuration, connect to the agent telnet console, use an API or even do it remotely using AirVantage platform.</p>
<p>In the following example, the programmatic approach is taken, using the dedicated API from swi_devicetree.h to access Agent parameters.</p>
<p>(You can have an overview of the swi_devicetree API by reading the section <code>5. Setting and Getting Agent Internal Variables</code>)</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;swi_devicetree.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> set_policies(){</div>
<div class="line">    <span class="comment">//init agent parameter access library</span></div>
<div class="line">    swi_dt_Init();</div>
<div class="line">    <span class="comment">//configure some policies</span></div>
<div class="line">    swi_dt_SetInteger(<span class="stringliteral">&quot;config.data.policy.hourly.latency&quot;</span>, 60*60);</div>
<div class="line">    swi_dt_SetBool(<span class="stringliteral">&quot;config.data.policy.manually.manual&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    swi_dt_SetString(<span class="stringliteral">&quot;config.data.policy.midnight.cron&quot;</span>, <span class="stringliteral">&quot;0 0 * * \*&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="SendingUndeclaredData"></a>
Sending Undeclared Data</h2>
<div class="fragment"><div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a6c7bd7a7dc05ec7a48f0728d32518b24">swi_av_asset_PushFloat</a>(<a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a>* asset, <span class="keyword">const</span> <span class="keywordtype">char</span> *pathPtr,  <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr, uint32_t timestamp, <span class="keywordtype">double</span> value);</div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a69a39a7b8eb6622c506b9cbdd1c0f31f">swi_av_asset_PushInteger</a>(<a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a>* asset, <span class="keyword">const</span> <span class="keywordtype">char</span> *pathPtr,  <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr, uint32_t timestamp, <span class="keywordtype">int</span> value);</div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a527461cd891bd8a459f1bc85a1b2a227">swi_av_asset_PushString</a>(<a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a>* asset, <span class="keyword">const</span> <span class="keywordtype">char</span> *pathPtr,  <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr, uint32_t timestamp, <span class="keyword">const</span> <span class="keywordtype">char</span>* value);</div>
</div><!-- fragment --><p>The path parameter specifies the datastore path under which data will be stored relative to the asset node, the last path segment will be used as a datastore key.</p>
<p>These functions send some data according to the specified policy (or the default policy if the policy is not specified).</p>
<p>Notice that for the server, all data is timestamped. If specific value <code>SWI_AV_TSTAMP_NO</code> is used, no timestamp is put in the record sent to the server, it will be timestamped at the date of its reception by the server.</p>
<p><b>Examples</b></p>
<div class="fragment"><div class="line"><a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a> *asset = NULL;</div>
<div class="line"></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a22b561de348628ee35ce54f8a9efd8b4">swi_av_Init</a>();  <span class="comment">// configure the library, establish connection with the agent</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// create asset</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a41d12a618696657cb8487316b7139ddd">swi_av_asset_Create</a>(&amp;asset, <span class="stringliteral">&quot;house&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">//Push integer 1 on path house.foo.x, timestamp is automatically generated at execution time on the device side by the</span></div>
<div class="line"><span class="comment">//library, data is linked to the default policy (Cf. NULL parameter)</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a69a39a7b8eb6622c506b9cbdd1c0f31f">swi_av_asset_PushInteger</a>(asset, <span class="stringliteral">&quot;foo.x&quot;</span>, NULL, <a class="code" href="swi__airvantage_8h.html#a3fe9dca31eb83c25303fe42408147e43a1af8ff28c4ee7fb0a05213d934aac081">SWI_AV_TSTAMP_AUTO</a>, 1);</div>
<div class="line"></div>
<div class="line"><span class="comment">//Push string &quot;bar&quot; on path house.foo.y, timestamp will be generated by AirVantage Server at reception time,</span></div>
<div class="line"><span class="comment">//data is linked to the `midnight` policy</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a527461cd891bd8a459f1bc85a1b2a227">swi_av_asset_PushString</a>(asset, <span class="stringliteral">&quot;foo.y&quot;</span>,  <span class="stringliteral">&quot;midnight&quot;</span>, <a class="code" href="swi__airvantage_8h.html#a3fe9dca31eb83c25303fe42408147e43a6441950bb26b3d017fb092e84412954b">SWI_AV_TSTAMP_NO</a>, <span class="stringliteral">&quot;bar&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="PredeclaredDataTables"></a>
Predeclared Data Tables</h2>
<p>Data tables can be declared as follows:</p>
<div class="fragment"><div class="line"> }</div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a8a00fa3f70e217de8d388cea2187aa92">swi_av_table_Create</a>(<a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a>* asset, <a class="code" href="swi__airvantage_8h.html#a96178218cc5e87b6f27a02f50bcaef09">swi_av_Table_t</a>** table, <span class="keyword">const</span> <span class="keywordtype">char</span>* pathPtr, <span class="keywordtype">size_t</span> numColumns,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>** columnNamesPtr, <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr, <a class="code" href="swi__airvantage_8h.html#a9ecc845c1fbee2853604f3ca964d4cfb">swi_av_Table_Storage_t</a> persisted, <span class="keywordtype">int</span> purge)</div>
</div><!-- fragment --><p>A table is associated with a given path (relative to the asset's root) and policy (default policy if unspecified). It can also have either a <code>STORAGE_RAM</code> or <code>STORAGE_RAM"</code> mode. Finally, it predeclares the columns which it handles; all records later pushed in the table must conform to this set of columns. The parameter <code>columnNamesPtr</code> is a list of column names as strings.</p>
<p>Using this API, if the data is meant to be timestamped on the device ( i.e. at sending/acquisition time) , then the table declaration <em>must</em> contain a column named <code>"timestamp"</code>, later on filed with integers.</p>
<p>In the future, columns will support more advanced settings, including serialization policies which affect their bandwidth usage vs. data precision compromise.</p>
<p>The result of this function is a table proxy object <code>table</code>, which supports methods <code>swi_av_table_PushFloat</code>, <code>swi_av_table_PushInteger</code>, and <code>swi_av_table_PushString</code>, to fill a row with each column value, and finally <code>swi_av_table_PushRow</code> to push the whole data row to the Agent.</p>
<p>Example</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *tableColumns[] = {</div>
<div class="line">    <span class="stringliteral">&quot;latitude&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;longitude&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;altitude&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;timestamp&quot;</span></div>
<div class="line">  };</div>
<div class="line"></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a8a00fa3f70e217de8d388cea2187aa92">swi_av_table_Create</a>(asset, &amp;table, <span class="stringliteral">&quot;position&quot;</span>, 4, tableColumns, <span class="stringliteral">&quot;hourly&quot;</span>, <a class="code" href="swi__airvantage_8h.html#a9ecc845c1fbee2853604f3ca964d4cfba030cdda3592d2bf014baad7efc6219aa">STORAGE_RAM</a>, 0);</div>
</div><!-- fragment --><h2><a class="anchor" id="PushingRows"></a>
Pushing Rows in a Predeclared Table</h2>
<div class="fragment"><div class="line"><span class="comment">//Push one value, pick-up the appropriate function</span></div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a359ec5d93d1ba799cde51b1184e8f6cc">swi_av_table_PushFloat</a>( <a class="code" href="swi__airvantage_8h.html#a96178218cc5e87b6f27a02f50bcaef09">swi_av_Table_t</a>* table, <span class="keywordtype">double</span> value);</div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a8ba67d561e601cb5ab70c6a662c31549">swi_av_table_PushInteger</a>( <a class="code" href="swi__airvantage_8h.html#a96178218cc5e87b6f27a02f50bcaef09">swi_av_Table_t</a>* table, <span class="keywordtype">int</span> value);</div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a8500301d4db2cfc2636e4fefd73f9743">swi_av_table_PushString</a>( <a class="code" href="swi__airvantage_8h.html#a96178218cc5e87b6f27a02f50bcaef09">swi_av_Table_t</a>* table, <span class="keyword">const</span> <span class="keywordtype">char</span>* value);</div>
<div class="line"><span class="comment">//Once the row is complete, push it to the Agent</span></div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#acec98300ef71254ada7465d14868d40c">swi_av_table_PushRow</a>( <a class="code" href="swi__airvantage_8h.html#a96178218cc5e87b6f27a02f50bcaef09">swi_av_Table_t</a>* table);</div>
</div><!-- fragment --><p>Push a row of data in a predeclared table. Keys must match the predeclared column names.</p>
<p>Example</p>
<div class="fragment"><div class="line"><a class="code" href="swi__airvantage_8h.html#a8ba67d561e601cb5ab70c6a662c31549">swi_av_table_PushInteger</a>(table, 49.171699); <span class="comment">//latitude</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a8ba67d561e601cb5ab70c6a662c31549">swi_av_table_PushInteger</a>(table, -123.070741); <span class="comment">//longitude</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a8ba67d561e601cb5ab70c6a662c31549">swi_av_table_PushInteger</a>(table, 5); <span class="comment">//altitude</span></div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#a8ba67d561e601cb5ab70c6a662c31549">swi_av_table_PushInteger</a>(table, time(NULL)); <span class="comment">//timestamp</span></div>
<div class="line">  </div>
<div class="line"><a class="code" href="swi__airvantage_8h.html#acec98300ef71254ada7465d14868d40c">swi_av_table_PushRow</a>(table);</div>
</div><!-- fragment --><h2><a class="anchor" id="ForcingPolicyFlush"></a>
Forcing a Policy Flush</h2>
<p>All the data attached to a given policy can be flushed to the server immediately with function:</p>
<div class="fragment"><div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#afa0b2e621845620265508da88d0bfd48">swi_av_TriggerPolicy</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr);</div>
</div><!-- fragment --><p>If <code>policyPtr</code> is passed as NULL, the default policy is used. If the special name <code><code>"*"</code></code> is passed, all policies are flushed.</p>
<h1><a class="anchor" id="ReceivingData"></a>
Receiving Data</h1>
<p><a class="el" href="air_vantage_connect_lib.html#WritingData">Writing Data</a> <br/>
 <a class="el" href="air_vantage_connect_lib.html#RegisteringReceivingFunctions">Registering a Function to handle data reception</a> <br/>
 <a class="el" href="air_vantage_connect_lib.html#AcknowledgingReceivedData">Acknowledging Received Data</a> <br/>
 <a class="el" href="air_vantage_connect_lib.html#DataReceivedSample">Received Data Sample</a> <br/>
 <a class="el" href="air_vantage_connect_lib.html#AgentIntVar">Setting and Getting Agent Internal Variables</a></p>
<h2><a class="anchor" id="WritingData"></a>
Writing Data</h2>
<p>AirVantage server is able to send data to a device in order to request some action on it: changing some configuration parameter, trigger some action etc. The data can be addressed to the AirVantage Agent or to another application, in any case the AirVantage Agent will receive the data first and then forward it to the appropriate application.</p>
<p>(FYI, AirVantage server can only modify data defined in the application data model as a setting, and not a variable.)</p>
<p>AirVantage Agent library provides API to enable your application to handle the reception of data coming from the AirVantage server.</p>
<h2><a class="anchor" id="RegisteringReceivingFunctions"></a>
Registering a Function to handle data reception</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> void (*<a class="code" href="swi__airvantage_8h.html#a0ac63a79fedd29aea57c37efea5b720b">swi_av_DataWriteCB</a>)(</div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a> *asset,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *pathPtr,</div>
<div class="line">    swi_dset_Iterator_t* data,</div>
<div class="line">    <span class="keywordtype">int</span> ack_id,</div>
<div class="line">    <span class="keywordtype">void</span> *userDataPtr</div>
<div class="line">);</div>
<div class="line"></div>
<div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#afd8557d5dd5039c4883ee77ffd0200ec">swi_av_RegisterDataWrite</a>( <a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a> *asset, <a class="code" href="swi__airvantage_8h.html#a0ac63a79fedd29aea57c37efea5b720b">swi_av_DataWriteCB</a> cb, <span class="keywordtype">void</span> * userDataPtr);</div>
</div><!-- fragment --><p>Once a callback has been registered, it will be called each time the server sends some data to the application, alongside with customizable userdata.</p>
<p>The <code>pathPtr</code> specifies the root path of the data, this way the application can determine what is the point the data being received. (e.g., the path can be "action1" or "action2" to provoke two different behavior of the application.)</p>
<p>The <code>data</code> object is meant to iterate over the values received. As received data are completely dynamic from the library point of view, this object makes it possible to abstract any kind of data the application can receive (string, integer, float, ...).</p>
<p>The application have to iterate over the object to get all received values. Let's take one example: acting on a garage door of a house. The message from the server could trigger this action with two parameters : the direction and the speed. In that example, the <code>pathPtr</code> could be "garageDoor", then the <code>data</code> object could contain 2 items: the first one named "direction" and value "up", the second named "speed" with value "max".</p>
<p>Finally the <code>ack_id</code> param is used to acknowledge the data, see the next section for that topic.</p>
<h2><a class="anchor" id="AcknowledgingReceivedData"></a>
Acknowledging Received Data</h2>
<p>When the AirVantage server sends data, it can request to receive an acknowledge to confirm the correct processing of the data by the application. This acknowledgment takes place at an applicative level, meaning that it is up to the application to acknowledge the data, once the appropriate actions have been taken.</p>
<p>AirVantage Agent library provides this function to fulfill this need.</p>
<div class="fragment"><div class="line">rc_ReturnCode_t <a class="code" href="swi__airvantage_8h.html#a82c7ead36e81069db2183419ff2f31fb">swi_av_Acknowledge</a>( <span class="keywordtype">int</span> ackId, <span class="keywordtype">int</span> status, <span class="keyword">const</span> <span class="keywordtype">char</span>* errMsgPtr, <span class="keyword">const</span> <span class="keywordtype">char</span>* policyPtr, <span class="keywordtype">int</span> persisted);</div>
</div><!-- fragment --><h2><a class="anchor" id="DataReceivedSample"></a>
Received Data Sample</h2>
<div class="fragment"><div class="line"><span class="comment">//will be called when the device received some data addressed to this application (asset). </span></div>
<div class="line">my_datacallback(swi_av_Asset *asset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, swi_dset_Iterator* data, <span class="keywordtype">int</span> ack_id, <span class="keywordtype">void</span> *userData){</div>
<div class="line">  <span class="keywordflow">if</span>(! strncmp(path, <span class="stringliteral">&quot;commands.setvalue&quot;</span>, strlen(<span class="stringliteral">&quot;command.setvalue&quot;</span>)) ){ <span class="comment">//known command</span></div>
<div class="line">   int64_t cmd_value;</div>
<div class="line">   assert(RC_OK == swi_dset_GetIntegerByName(data, <span class="stringliteral">&quot;cmd_value&quot;</span>, &amp;cmd_value) );</div>
<div class="line">   setvalue(cmd_value);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span>{ <span class="comment">//unknown command/writing, just print the request</span></div>
<div class="line">     printf(<span class="stringliteral">&quot;received data on path[%s]:\n&quot;</span>, path);</div>
<div class="line">     <span class="keywordflow">while</span>(RC_NOT_FOUND != swi_dset_Next(data) ){</div>
<div class="line">       printf(<span class="stringliteral">&quot;data name: [%s]\n&quot;</span>, swi_dset_GetName(data));</div>
<div class="line">       <span class="comment">//...</span></div>
<div class="line">     }</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">//server requested acknowledgement</span></div>
<div class="line">  <span class="keywordflow">if</span>(ack_id)</div>
<div class="line">    <a class="code" href="swi__airvantage_8h.html#a82c7ead36e81069db2183419ff2f31fb">swi_av_Acknowledge</a>(ack_id, 0, NULL, <span class="stringliteral">&quot;now&quot;</span>, 1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">main(...){</div>
<div class="line">  <a class="code" href="swi__airvantage_8h.html#aa496611e5e068185d1ad3f68d42be039">swi_av_Asset_t</a> *asset = NULL;  </div>
<div class="line">  <span class="comment">// configure the library, establish connection with the agent</span></div>
<div class="line">  <a class="code" href="swi__airvantage_8h.html#a22b561de348628ee35ce54f8a9efd8b4">swi_av_Init</a>();</div>
<div class="line">  <span class="comment">// create asset</span></div>
<div class="line">  <a class="code" href="swi__airvantage_8h.html#a41d12a618696657cb8487316b7139ddd">swi_av_asset_Create</a>(&amp;asset, <span class="stringliteral">&quot;house&quot;</span>);</div>
<div class="line">  <span class="comment">// register callback for data reception</span></div>
<div class="line">  <a class="code" href="swi__airvantage_8h.html#afd8557d5dd5039c4883ee77ffd0200ec">swi_av_RegisterDataWrite</a>(asset, my_datacallback, NULL)</div>
<div class="line">  <span class="comment">// start asset (ready to send/receive data).</span></div>
<div class="line">  <a class="code" href="swi__airvantage_8h.html#a5805cec0a0fb09df60324657c6159eba">swi_av_asset_Start</a>(asset);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="AgentIntVar"></a>
Setting and Getting Agent Internal Variables</h1>
<p>The Agent has a list of internal variables that can be manipulated by a user application. For instance, these variables allow to interact with the Agent configuration.</p>
<p>The provided "Get" and "Set" API allow to access those Agent internal variables.</p>
<p>The <code>swi_dt_Get</code> API allows you to retrieve the value of a terminal variable as well as to retrieve and discover branches of the tree representation of variables.</p>
<p>The <code>swi_dt_SetInteger</code>, <code>swi_dt_SetFloat</code>, <code>swi_dt_SetString</code>, <code>swi_dt_SetNull</code>, <code>swi_dt_SetBool</code> API allow you to set the value of a terminal variable and to create a new variable when it does not exist.</p>
<p>The <code>swi_dt_Register</code> API allows you to subscribe to change on individual variables, on whole sub-trees, or on a mix thereof. It also handles passive variables: normally, when a callback is triggered because some registered variables changed, it only receives the variables whose values changed as parameters. If some passive variables are listed during the registration, their content is always passed to the callback, whether it changed or not. A change in a passive variable won't trigger the callback, though&ndash;unless it is also listed as an active one.</p>
<hr/>
<p>Copyright (C) 2014 Sierra Wireless, Inc. Use of this work is subject to license. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
   <div class="footer">
        <div>
            <a href="http://www.sierrawireless.com/">
                <img src="swi-ico-medium.png" width="24" alt="" />
                &nbsp;Sierra Wireless
            </a>
            &nbsp;-&nbsp;
            Generated by Doxygen 1.8.6
        </div>
    </div>
</body>
</html>
