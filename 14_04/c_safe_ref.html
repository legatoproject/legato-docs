<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Legato: Safe References API</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="fonts.css" rel="stylesheet" type="text/css" />
<link href="legato.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

<link rel="icon" type="image/png" href="favicon.ico" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo">
    <img alt="Logo" src="legatoLogo.png"/>
    <div id="projectbrief">Wireless M2M smooth and connected</div>
  </td>
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('c_safe_ref.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Safe References API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="le__safe_ref_8h.html">Click here for the API reference documentation.</a></p>
<hr/>
<p><a class="el" href="c_safe_ref.html#c_safeRef_usage">Usage</a> <br/>
 <a class="el" href="c_safe_ref.html#c_safeRef_multithreading">Multithreading</a> <br/>
 <a class="el" href="c_safe_ref.html#c_safeRef_example">Sample Code</a> <br/>
</p>
<p>The term "reference" is used to mean "opaque data that refers to some conceptual object". It is intentionally vague to support "information hiding". Behind the scenes, different implementations can use almost anything that fits into a pointer as a "reference". Often, they are indexes into arrays or actual pointers to memory objects. When passing those references through an API to outside clients, the implementation becomes exposed to crash bugs when clients pass those references back into the API damaged or stale ("stale" meaning something that has been deleted).</p>
<p><b> Safe References </b> are designed to help protect against damaged or stale references being used by clients.</p>
<h2><a class="anchor" id="c_safeRef_usage"></a>
Usage</h2>
<p>Here's the basic usage pattern for safe references:</p>
<p>Client calls an API's "Create" function:</p>
<ul>
<li>"Create" function creates an object.</li>
<li>"Create" function creates a "Safe Reference" for the new object (<a class="el" href="le__safe_ref_8h.html#a458597757cbce48e03413b49f52ec240">le_ref_CreateRef()</a>).</li>
<li>"Create" function returns the Safe Reference.</li>
</ul>
<p>Followed by:</p>
<p>Client calls another API function, passing in the Safe Reference:</p>
<ul>
<li>API function translates the Safe Reference back into an object pointer (<a class="el" href="le__safe_ref_8h.html#a488dddfd579f4a20f39be392c4d7d2e0">le_ref_Lookup()</a>)</li>
<li>API function acts on the object.</li>
</ul>
<p>Finishing with:</p>
<p>Client calls API's "Delete" function, passing in the Safe Reference:</p>
<ul>
<li>"Delete" function translates the Safe Reference back into a pointer to its object.</li>
<li>"Delete" function invalidates the Safe Reference (<a class="el" href="le__safe_ref_8h.html#a438e18b8ace1d4dda3ca5144a27bd424">le_ref_DeleteRef()</a>).</li>
<li>"Delete" function deletes the object.</li>
</ul>
<p>At this point, if the Client calls an API function and passes that same (now invalid) Safe Reference (or if the client accidentally passes in some garbage value, like a pointer or zero), the API function will try to translate that into an object pointer. But it'll be told that it's an invalid Safe Reference. The API function can then handle it gracefully, rather than just acting as if it were a valid reference and clobbering the object's deallocated memory or some other object that's reusing the old object's memory.</p>
<p>A <b> Reference Map </b> object is used to create Safe References and keep track of the mappings from Safe References to pointers. At start-up, a Reference Map is created by calling <code><a class="el" href="le__safe_ref_8h.html#a85faf3c75723a1af0e1adf720d9c9dca">le_ref_CreateMap()</a></code>. It takes a single argument, the maximum number of mappings expected to track of at any time.</p>
<h2><a class="anchor" id="c_safeRef_multithreading"></a>
Multithreading</h2>
<p>This API's functions are reentrant, but not thread safe. If there's the slightest possibility the same Reference Map will be accessed by two threads at the same time, use a mutex or some other thread synchronization mechanism to protect the Reference Map from concurrent access.</p>
<h2><a class="anchor" id="c_safeRef_example"></a>
Sample Code</h2>
<h3><a class="anchor" id="c_safeRef_example_api"></a>
API Definition</h3>
<div class="fragment"><pre class="fragment"> <span class="comment">// Opaque reference to Foo objects.</span>
 <span class="keyword">typedef</span> <span class="keyword">struct </span>xyz_foo_Obj* xyz_foo_ObjRef_t;

 xyz_foo_Ref_t xyz_foo_CreateObject
 (
     <span class="keywordtype">void</span>
 );

 <span class="keywordtype">void</span> xyz_foo_DoSomething
 (
     xyz_foo_Ref_t objRef
 );

 <span class="keywordtype">void</span> xyz_foo_DeleteObject
 (
     xyz_foo_Ref_t objRef
 );
</pre></div><h3><a class="anchor" id="c_safeRef_example_implementation"></a>
API Implementation Code Sample</h3>
<div class="fragment"><pre class="fragment"> <span class="comment">// Maximum number of Foo objects we expect to have at one time.</span>
<span class="preprocessor"> #define MAX_FOO_OBJECTS  27</span>
<span class="preprocessor"></span>
 <span class="comment">// Actual Foo objects.</span>
 <span class="keyword">typedef</span> <span class="keyword">struct</span>
 {
     ...
 }
 Foo_t;

 <span class="comment">// Pool from which Foo objects are allocated.</span>
 le_mem_PoolRef_t FooPool;

 <span class="comment">// Safe Reference Map for Foo objects.</span>
 <a class="code" href="le__safe_ref_8h.html#aaf8fb3412fb840cb50366856affaf69b">le_ref_MapRef_t</a> FooRefMap;

 <a class="code" href="le__event_loop_8h.html#abdb9187a56836a93d19cc793cbd4b7ec">COMPONENT_INIT</a>
 {
     <span class="comment">// Create the Foo object pool.</span>
     FooPool = <a class="code" href="le__mem_8h.html#afc7288e04f1afff41a83a4da974726ab">le_mem_CreatePool</a>(<span class="stringliteral">&quot;FooPool&quot;</span>, <span class="keyword">sizeof</span>(Foo_t));
     <a class="code" href="le__mem_8h.html#a79a4321ffa0345f267eaf3b7d3d3528a">le_mem_ExpandPool</a>(FooPool, MAX_FOO_OBJECTS);

     <span class="comment">// Create the Safe Reference Map to use for Foo object Safe References.</span>
     FooRefMap = <a class="code" href="le__safe_ref_8h.html#a85faf3c75723a1af0e1adf720d9c9dca">le_ref_CreateMap</a>(<span class="stringliteral">&quot;FooMap&quot;</span>, MAX_FOO_OBJECTS);
 };

 xyz_foo_Ref_t xyz_foo_CreateObject
 (
     <span class="keywordtype">void</span>
 )
 {
     Foo_t* fooPtr = <a class="code" href="le__mem_8h.html#af7c289c73d4182835a26a9099f3db359">le_mem_ForceAlloc</a>(FooPool);

     <span class="comment">// Initialize the new Foo object.</span>
     ...

     <span class="comment">// Create and return a Safe Reference for this Foo object.</span>
     <span class="keywordflow">return</span> <a class="code" href="le__safe_ref_8h.html#a458597757cbce48e03413b49f52ec240">le_ref_CreateRef</a>(FooRefMap, fooPtr);
 }

 <span class="keywordtype">void</span> xyz_foo_DoSomething
 (
     xyz_foo_Ref_t objRef
 )
 {
     Foo_t* fooPtr = <a class="code" href="le__safe_ref_8h.html#a488dddfd579f4a20f39be392c4d7d2e0">le_ref_Lookup</a>(FooRefMap, objRef);

     <span class="keywordflow">if</span> (fooPtr == NULL)
     {
         <a class="code" href="le__log_8h.html#a5efa1e4b6292c820c8555b4066a5c10d">LE_CRIT</a>(<span class="stringliteral">&quot;Invalid reference (%p) provided!&quot;</span>, objRef);
         <span class="keywordflow">return</span>;
     }

     <span class="comment">// Do something to the object.</span>
     ...
 }

 <span class="keywordtype">void</span> xyz_foo_DeleteObject
 (
     xyz_foo_Ref_t objRef
 )
 {
     Foo_t* fooPtr = <a class="code" href="le__safe_ref_8h.html#a488dddfd579f4a20f39be392c4d7d2e0">le_ref_Lookup</a>(FooRefMap, objRef);

     <span class="keywordflow">if</span> (fooPtr == NULL)
     {
         <a class="code" href="le__log_8h.html#a5efa1e4b6292c820c8555b4066a5c10d">LE_CRIT</a>(<span class="stringliteral">&quot;Invalid reference (%p) provided!&quot;</span>, objRef);
         <span class="keywordflow">return</span>;
     }

     <span class="comment">// Invalidate the Safe Reference.</span>
     <a class="code" href="le__safe_ref_8h.html#a438e18b8ace1d4dda3ca5144a27bd424">le_ref_DeleteRef</a>(FooRefMap, objRef);

     <span class="comment">// Release the Foo object.</span>
     <a class="code" href="le__mem_8h.html#a6d8e3fe430bcb81efe97b57ce30ef2de">le_mem_Release</a>(fooPtr);
 }
</pre></div><hr/>
<p>Copyright (C) Sierra Wireless, Inc. 2013. All rights reserved. Use of this work is subject to license. </p>
</div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div>
  <div id="nav-path" class="navpath">
    <ul>
   <div class="footer">
        <div>
            <a href="http://www.sierrawireless.com/">
                <img src="swi-ico-medium.png" width="24" alt="" />
                &nbsp;Sierra Wireless 2014
            </a>
            &nbsp;-&nbsp;
            Generated by Doxygen 1.7.6.1
        </div>
    </div>
</body>
</html>
