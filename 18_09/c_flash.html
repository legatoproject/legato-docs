<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html data-context="Build Apps" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Flash API  - Legato Docs</title>
<meta content="legato™ is an open source Linux-based embedded platform designed to simplify connected IoT application development" name="description"/>
<meta content="legato, iot" name="keywords"/>
<meta content="18.09.0" name="legato-version"/>
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<link href="resources/images/legato.ico" rel="shortcut icon"/>
<link href="resources/images/legato.ico" rel="icon" type="image/x-icon"/>
<link href="resources/images/legato.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="resources/images/legato.ico" rel="apple-touch-icon" type="image/x-icon"/>
<link href="resources/css/style.css" media="screen" rel="stylesheet" type="text/css"/>
<link href="resources/css/font-awesome.css" rel="stylesheet" type="text/css"/>
<!--[if IE]>
        <script src="resources/js/html5shiv.js"></script>
        <script src="resources/js/respond.js"></script>
        <![endif]-->
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
<script src="resources/js/main.js"></script>
<script src="tocs/Build_Apps_API_Guides.json"></script>
</head>
<body>
<noscript>
<input class="modal-closing-trick" id="modal-closing-trick" type="checkbox"/>
<div id="nojs">
<label for="modal-closing-trick">
<span>You seem to not have Javascript <a href="http://enable-javascript.com">enabled</a>, so site functionality like the search and navigation tree won't work.</span>
</label>
</div>
</noscript>
<div class="wrapper">
<div class="fa fa-bars documentation" id="menu-trigger"></div>
<div id="top">
<header>
<nav>
<a class="navlink" href="/">Introduction</a><a class="navlink selected" href="buildAppsMain.html">Build Apps</a><a class="navlink" href="buildPlatformMain.html">Build Platform</a><a class="navlink" href="aboutMain.html">About</a>
</nav>
</header>
</div>
<div class="white" id="menudocumentation">
<header>
<a href="/"> <img alt="Back to Legato Homepage" id="logo" src="resources/images/legato_logo.png"/></a>
<h2>/ Build Apps</h2>
<nav class="secondary">
<a href="getStarted.html">Get Started</a><a href="concepts.html">Concepts</a><a class="link-selected" href="apiGuidesMain.html">API Guides</a><a href="tools.html">Tools</a><a href="howToMain.html">How To</a>
</nav>
<nav class="ui-front">
<i class="fa fa-search" id="search-icon"></i>
<input id="searchbox" placeholder="Search"/>
</nav>
</header>
</div>
<div id="resizable">
<div id="left">
<div id="tree1"></div>
</div>
</div>
<div class="content">
<div class="header">
<div class="headertitle">
<h1 class="title">Flash API </h1> </div>
</div><div class="contents">
<div class="textblock"><p><a class="el" href="le__flash__interface_8h.html">API Reference</a></p>
<hr/>
<p>This file contains data structures and prototypes definitions for high level Flash APIs.</p>
<p>The goal is to provide an API to update an image recorded:</p><ul>
<li>in a flash partition in RAW mode at the block layer, using a Memory Technology Device (MTD).</li>
<li>in an Unsorted Block Images (UBI) volume, using a MTD and updating UBI information and headers.</li>
</ul>
<h1><a class="anchor" id="le_flash_binding"></a>
IPC interfaces binding</h1>
<p>All the functions of this API are provided by the <b>fwupdateService</b>.</p>
<p>Here's a code sample binding to the flash service: </p><pre class="fragment">bindings:
{
   clientExe.clientComponent.le_flash -&gt; fwupdateService.le_flash
}
</pre><dl class="section warning"><dt>Warning</dt><dd>These APIs are not available for all platforms. Please refer to the Product Technical Specification document of your platform for further details. Please refer to <a class="el" href="platformConstraintsFlash.html">Flash</a> for details.</dd></dl>
<h1><a class="anchor" id="le_flash_BadImageDetection"></a>
Bad image detection</h1>
<p>This functionality allows the user to be notified when an image becomes bad.</p>
<ul>
<li><a class="el" href="le__flash__interface_8h.html#a95574e6e395ef5dc5877ebf9b4e2a19f">le_flash_AddBadImageDetectionHandler()</a> API adds a handler to notify when an image becomes bad</li>
<li><a class="el" href="le__flash__interface_8h.html#a9e395cd7955381a119bd353cc1023554">le_flash_RemoveBadImageDetectionHandler()</a> API removes the bad image handler</li>
</ul>
<h1><a class="anchor" id="flash_Protection"></a>
Flash access protection</h1>
<p>To address race conditions, <a class="el" href="le__flash__interface_8h.html#a5b1c0d8884bfe843dd33a2ac25e4bf3f">le_flash_RequestAccess()</a> has to be called first before trying to access to the flash. When all flash modifications are done, <a class="el" href="le__flash__interface_8h.html#a935bb23268e1311fa6d9d0fb0e90606a">le_flash_ReleaseAccess()</a> is required.</p>
<h1><a class="anchor" id="le_flash_Open"></a>
Open a partition</h1>
<p>Depending on how the read/write operations have to be done, the correct open API has to be used:</p><ul>
<li><a class="el" href="le__flash__interface_8h.html#a201ac5e6437c377c2c77ac25a0b0e0f0">le_flash_OpenMtd()</a> when the flash image is reachable at the block layer.</li>
<li><a class="el" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi()</a> when the image is reachable through a UBI. Then <a class="el" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume()</a> needs to be called to set the volume to be accessed. Volume can be set several time successively. <a class="el" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume()</a> has to be called before changing the volume. Please refer to <a class="el" href="platformConstraintsFlash.html">Flash</a> for details.</li>
</ul>
<p>A sample code showing how to open, retrieve information and close can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Retrieve information about an open partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_Info</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize;</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given MTD partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a201ac5e6437c377c2c77ac25a0b0e0f0">le_flash_OpenMtd</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the MTD</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> A sample code showing how to open UBI, retrieve UBI information and close UBI can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Retrieve information about an UBI volume</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_InfoUbi</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize;</div><div class="line">    uint32_t freeBlock, volBlock, volSize;</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open an UBI volume belonging to this UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume</a>(partRef, ubiVolStr, <a class="code" href="le__flash__interface_8h.html#a665479827533ef84335f7b2fb2a21b52">LE_FLASH_UBI_VOL_NO_SIZE</a>);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Free Block %u, Allocated Block to Volume %u, Volume Size %u"</span>,</div><div class="line">            freeBlock, volBlock, volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --> <h1><a class="anchor" id="le_flash_Close"></a>
Close a partition</h1>
<p>When the read/write operation are over, the application has to call <a class="el" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close()</a> API to release resources and make the partition usable.</p>
<h1><a class="anchor" id="le_flash_EraseBlock"></a>
Erase a block inside a partition</h1>
<p>When a block needs to be erased; the application has to call <a class="el" href="le__flash__interface_8h.html#aa7cf4492e183d50c6acd91a09dd8e379">le_flash_EraseBlock()</a> API to perform the erase operation on the given block index. If the erase fails, the block is marked "bad".</p>
<h1><a class="anchor" id="le_flash_Read"></a>
Read a data chunk</h1>
<p>To read data, <a class="el" href="le__flash__interface_8h.html#aeade27f3e79bc31562f03a55c2720205">le_flash_Read()</a> has to be called. The data are read at the specified block index. Note that this index is not the index of the block into the partition, but a logical block index:</p><ul>
<li>the bad blocks are skipped.</li>
<li>the blocks are not into a consecutive order for UBI volume.</li>
</ul>
<p>The data length to be read can't be higher than:</p><ul>
<li>an erase block size for MTD usage partition</li>
<li>an erase block size minus 2 pages for UBI partitions (UBI uses 2 pages for its internal need)</li>
</ul>
<p>A sample code showing how to read a whole partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Dump all blocks from a MTD partition into a file</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_Dump</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *toFile = args[1];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize, blockIdx, size;</div><div class="line">    <span class="keywordtype">int</span> writeSize;</div><div class="line">    <span class="keywordtype">int</span> toFd;</div><div class="line">    uint8_t rData[<a class="code" href="le__flash__interface_8h.html#ae8c2597f274805d3f2eb9d75eebb1cb7">LE_FLASH_MAX_READ_SIZE</a>];</div><div class="line"> </div><div class="line">    toFd = open(toFile, O_WRONLY | O_TRUNC | O_CREAT, 0644);</div><div class="line">    <span class="keywordflow">if</span> (-1 == toFd)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Failed to open '%s': %m"</span>, toFile);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given MTD partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a201ac5e6437c377c2c77ac25a0b0e0f0">le_flash_OpenMtd</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Loop for all blocks of the partition, try to read it and dump it to the file</span></div><div class="line">    <span class="keywordflow">for</span>(blockIdx = 0; blockIdx &lt; numBlock; blockIdx++)</div><div class="line">    {</div><div class="line">        <span class="comment">// Read the whole erase block size</span></div><div class="line">        <span class="comment">// As we read in RAW, the whole erase block is read by once</span></div><div class="line">        size = <span class="keyword">sizeof</span>(rData);</div><div class="line">        res = <a class="code" href="le__flash__interface_8h.html#aeade27f3e79bc31562f03a55c2720205">le_flash_Read</a>(partRef, blockIdx, rData, &amp;size);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"le_flash_Read failed: %d"</span>, res);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a2a91ea8857cf190fde71d85ba930a498">LE_DEBUG</a>(<span class="stringliteral">"Read blockIdx %u size %u"</span>, blockIdx, size);</div><div class="line"> </div><div class="line">        <span class="comment">// Write to file</span></div><div class="line">        writeSize = write(toFd, rData, size);</div><div class="line">        <span class="keywordflow">if</span> (-1 == writeSize)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Write to file failed: %m"</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> == res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Read %u blocks from partition \"%s\""</span>, blockIdx, partNameStr);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the MTD</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    close(toFd);</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> A sample code showing how to read a whole UBI volume inside an UBI partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Dump a whole UBI volume from an UBI partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_DumpUbi</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *toFile = args[2];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize, blockIdx, size;</div><div class="line">    uint32_t freeBlock, volBlock, volSize, readVolSize = 0;</div><div class="line">    <span class="keywordtype">int</span> writeSize;</div><div class="line">    <span class="keywordtype">int</span> toFd;</div><div class="line">    uint8_t rData[<a class="code" href="le__flash__interface_8h.html#ae8c2597f274805d3f2eb9d75eebb1cb7">LE_FLASH_MAX_READ_SIZE</a>];</div><div class="line"> </div><div class="line">    toFd = open(toFile, O_WRONLY | O_TRUNC | O_CREAT, 0644);</div><div class="line">    <span class="keywordflow">if</span> (-1 == toFd)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Failed to open '%s': %m"</span>, toFile);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open an UBI volume belonging to this UBI partition</span></div><div class="line">    <span class="comment">// As the UBI is open is R/O, discard the volume size to adjust when le_flash_CloseUbiVolume()</span></div><div class="line">    <span class="comment">// is called.</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume</a>(partRef, ubiVolStr, <a class="code" href="le__flash__interface_8h.html#a665479827533ef84335f7b2fb2a21b52">LE_FLASH_UBI_VOL_NO_SIZE</a>);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Free Block %u, Allocated Block to Volume %u, Volume Size %u"</span>,</div><div class="line">            freeBlock, volBlock, volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(toFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Loop for all blocks of the UBI volume, try to read it and dump it to the file</span></div><div class="line">    <span class="keywordflow">for</span>(blockIdx = 0; blockIdx &lt; volBlock; blockIdx++)</div><div class="line">    {</div><div class="line">        <span class="comment">// Read the whole erase block size</span></div><div class="line">        <span class="comment">// As we read in UBI, the whole erase block is read by once minus some administrative</span></div><div class="line">        <span class="comment">// pages. The size reported by the le_flash_Read() is real size read.</span></div><div class="line">        size = <span class="keyword">sizeof</span>(rData);</div><div class="line">        res = <a class="code" href="le__flash__interface_8h.html#aeade27f3e79bc31562f03a55c2720205">le_flash_Read</a>(partRef, blockIdx, rData, &amp;size);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"le_flash_Read failed: %d"</span>, res);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a2a91ea8857cf190fde71d85ba930a498">LE_DEBUG</a>(<span class="stringliteral">"Read blockIdx %u size %u"</span>, blockIdx, size);</div><div class="line">        readVolSize += size;</div><div class="line"> </div><div class="line">        writeSize = write(toFd, rData, size);</div><div class="line">        <span class="keywordflow">if</span> (-1 == writeSize)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Write to file failed: %m"</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    close(toFd);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> == res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Read %u blocks from UBI partition \"%s\" volume \"%s\""</span>,</div><div class="line">                blockIdx, partNameStr, ubiVolStr);</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Volume size read %u, expected volume size %u"</span>, readVolSize, volSize);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" close ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --> <h1><a class="anchor" id="le_flash_Write"></a>
Write a data chunk</h1>
<p>To write some data, <a class="el" href="le__flash__interface_8h.html#a4710e671736b31623bde38a0a45dd6be">le_flash_Write()</a> can be used. The data are written at a specified block index. This index is a logical block index (see <a class="el" href="c_flash.html#le_flash_Read">Read a data chunk</a>). The block is firstly erased, so no call to <a class="el" href="le__flash__interface_8h.html#aa7cf4492e183d50c6acd91a09dd8e379">le_flash_EraseBlock()</a> is needed. If the erase or the write reports an error, the block is marked "bad" and the write starts again at the next physical block. The data length to be written can't be higher than:</p><ul>
<li>an erase block size for MTD usage partition</li>
<li>an erase block size minus 2 pages for UBI partitions (UBI uses 2 pages for its internal need)</li>
</ul>
<p>A sample code showing how to write a whole partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Flash a file into a MTD partition and erase remaining blocks up to end of the partition if any</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_FlashErase</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *fromFile = args[1];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize, blockIdx, size, readSize;</div><div class="line">    uint32_t writeBadBlock, eraseBadBlock;</div><div class="line">    <span class="keywordtype">int</span> fromFd;</div><div class="line">    uint8_t rData[<a class="code" href="le__flash__interface_8h.html#ae8c2597f274805d3f2eb9d75eebb1cb7">LE_FLASH_MAX_READ_SIZE</a>];</div><div class="line"> </div><div class="line">    fromFd = open(fromFile, O_RDONLY);</div><div class="line">    <span class="keywordflow">if</span> (-1 == fromFd)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Failed to open '%s': %m"</span>, fromFile);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given MTD partition in W/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a201ac5e6437c377c2c77ac25a0b0e0f0">le_flash_OpenMtd</a>(partNameStr, LE_FLASH_WRITE_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Loop for all blocks of the partition, try to read from the file and flash the erase block</span></div><div class="line">    <span class="comment">// into the partition</span></div><div class="line">    <span class="keywordflow">for</span>(blockIdx = 0; blockIdx &lt; numBlock; blockIdx++)</div><div class="line">    {</div><div class="line">        <span class="comment">// Read the whole erase block size</span></div><div class="line">        size = eraseBlockSize;</div><div class="line">        readSize = read(fromFd, rData, size);</div><div class="line">        <span class="keywordflow">if</span> (-1 == readSize)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Read from file failed: %m"</span>);</div><div class="line">            res = <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="comment">// Nothing to read, file is complete</span></div><div class="line">        <span class="keywordflow">if</span> (0 == readSize)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"> </div><div class="line">        <span class="comment">// Write the whole erase block size</span></div><div class="line">        <span class="comment">// As we write in RAW, the whole erase block is written by once</span></div><div class="line">        <span class="comment">// The Flash layer will perform an erase before writing. We do not need to call it.</span></div><div class="line">        <span class="comment">// If the write fails or the erase fails, the block will be marked bad and the write</span></div><div class="line">        <span class="comment">// starts again at the next block.</span></div><div class="line">        res = <a class="code" href="le__flash__interface_8h.html#a4710e671736b31623bde38a0a45dd6be">le_flash_Write</a>(partRef, blockIdx, rData, readSize);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"le_flash_Write failed: %d"</span>, res);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="comment">// As blocks are marked bad, it may happen that we cannot write the whole file into</span></div><div class="line">        <span class="comment">// the Flash partition if too many bad blocks are found.</span></div><div class="line">        <a class="code" href="le__log_8h.html#a2a91ea8857cf190fde71d85ba930a498">LE_DEBUG</a>(<span class="stringliteral">"Write blockIdx %u size %u"</span>, blockIdx, size);</div><div class="line">    }</div><div class="line">    close(fromFd);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> == res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Written %u blocks to partition \"%s\""</span>, blockIdx, partNameStr);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information to look for "new bad blocks"</span></div><div class="line">    writeBadBlock = 0;</div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef,</div><div class="line">                                       &amp;writeBadBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res) || (writeBadBlock &gt; badBlock))</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"New bad blocks marked during write: %u (%u - %u)"</span>, writeBadBlock - badBlock,</div><div class="line">                 writeBadBlock, badBlock);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Erasing remaining blocks: blockIdx %u numBlock %u"</span>, blockIdx, numBlock);</div><div class="line">    <span class="keywordflow">for</span> ( ; blockIdx &lt; numBlock; blockIdx++)</div><div class="line">    {</div><div class="line">        <span class="comment">// Erase the block. If the erase fails, the block is marked bad.</span></div><div class="line">        res = <a class="code" href="le__flash__interface_8h.html#aa7cf4492e183d50c6acd91a09dd8e379">le_flash_EraseBlock</a>(partRef, blockIdx);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"le_flash_EraseBlock %u failed: %d"</span>, blockIdx, res);</div><div class="line">            <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">            <span class="keywordflow">return</span> res;</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a2a91ea8857cf190fde71d85ba930a498">LE_DEBUG</a>(<span class="stringliteral">"Erase blockIdx %u"</span>, blockIdx);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information to look for "new bad blocks"</span></div><div class="line">    eraseBadBlock = 0;</div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef,</div><div class="line">                                       &amp;eraseBadBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res) || (eraseBadBlock &gt; writeBadBlock))</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"New bad blocks marked during erase: %u (%u - %u)"</span>, eraseBadBlock - writeBadBlock,</div><div class="line">                 eraseBadBlock, writeBadBlock);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the MTD</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> A sample code showing how to write a whole UBI volume inside an UBI partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Flash a whole UBI volume from a file into an UBI partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_FlashUbi</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *fromFile = args[2];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize, blockIdx, size;</div><div class="line">    uint32_t freeBlock, volBlock, volSize, writeVolSize = 0;</div><div class="line">    <span class="keywordtype">int</span> readSize;</div><div class="line">    <span class="keywordtype">int</span> fromFd;</div><div class="line">    uint8_t rData[<a class="code" href="le__flash__interface_8h.html#ae8c2597f274805d3f2eb9d75eebb1cb7">LE_FLASH_MAX_READ_SIZE</a>];</div><div class="line">    <span class="keyword">struct </span>stat st;</div><div class="line"> </div><div class="line">    fromFd = open(fromFile, O_RDONLY);</div><div class="line">    <span class="keywordflow">if</span> (-1 == fromFd)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Failed to open '%s': %m"</span>, fromFile);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in W/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_WRITE_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open an UBI volume belonging to this UBI partition</span></div><div class="line">    <span class="comment">// Get the size of file. This will be needed to "adjust" the UBI volume size after it was</span></div><div class="line">    <span class="comment">// fully written. This size is passed to le_flash_OpenUbiVolume() and the UBI volume will be</span></div><div class="line">    <span class="comment">// resized when le_flash_CloseUbiVolume() is called. Using LE_FLASH_UBI_VOL_NO_SIZE instead</span></div><div class="line">    <span class="comment">// will keep the volume size unchanged.</span></div><div class="line">    fstat(fromFd, &amp;st);</div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume</a>(partRef, ubiVolStr, st.st_size);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Free Block %u, Allocated Block to Volume %u, Volume Size %u"</span>,</div><div class="line">            freeBlock, volBlock, volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        close(fromFd);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Loop until the whole size of the file has been read.</span></div><div class="line">    <span class="keywordflow">for</span>(blockIdx = 0; writeVolSize &lt; st.st_size; blockIdx++)</div><div class="line">    {</div><div class="line">        <span class="comment">// The erase block size contains all UBI header and data information. We need to</span></div><div class="line">        <span class="comment">// remove the 2 write pages to get the whole data size.</span></div><div class="line">        size = eraseBlockSize - (2*pageSize);</div><div class="line">        readSize = read(fromFd, rData, size);</div><div class="line">        <span class="keywordflow">if</span> (-1 == readSize)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Read from file failed: %m"</span>);</div><div class="line">            res = <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="comment">// Nothing to read, file is complete</span></div><div class="line">        <span class="keywordflow">if</span> (0 == readSize)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"> </div><div class="line">        <span class="comment">// Write the whole erase block size</span></div><div class="line">        <span class="comment">// As we write in UBI, the whole erase block is read by once minus some administrative</span></div><div class="line">        <span class="comment">// pages.</span></div><div class="line">        <span class="comment">// The Flash layer will perform an erase before writing. We do not need to call it.</span></div><div class="line">        <span class="comment">// If the write fails or the erase fails, the block will be marked bad and the write</span></div><div class="line">        <span class="comment">// starts again at the next block.</span></div><div class="line">        <span class="comment">// If a new block is required to store data into the volume, the Flash layer will allocate</span></div><div class="line">        <span class="comment">// it to the volume and fill the administrative headers.</span></div><div class="line">        res = <a class="code" href="le__flash__interface_8h.html#a4710e671736b31623bde38a0a45dd6be">le_flash_Write</a>(partRef, blockIdx, rData, readSize);</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">        {</div><div class="line">            <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"le_flash_Write failed: %d"</span>, res);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <a class="code" href="le__log_8h.html#a2a91ea8857cf190fde71d85ba930a498">LE_DEBUG</a>(<span class="stringliteral">"Write blockIdx %u size %u"</span>, blockIdx, readSize);</div><div class="line">        writeVolSize += readSize;</div><div class="line">    }</div><div class="line">    close(fromFd);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> == res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Write %u blocks to UBI partition \"%s\" volume \"%s\""</span>,</div><div class="line">                blockIdx, partNameStr, ubiVolStr);</div><div class="line">        <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Volume size written %u, expected volume size %u"</span>,</div><div class="line">                writeVolSize, (uint32_t)st.st_size);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume. If a specific volume size was passed to le_flash_OpenUbiVolume(), the</span></div><div class="line">    <span class="comment">// volume size will be adjusted to it. Blocks over the volume size will be released and given</span></div><div class="line">    <span class="comment">// back to the UBI partition.</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" close ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Just re-open the same volume without size to check that the UBI volume was resized correctly.</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume</a>(partRef, ubiVolStr, <a class="code" href="le__flash__interface_8h.html#a665479827533ef84335f7b2fb2a21b52">LE_FLASH_UBI_VOL_NO_SIZE</a>);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information and check that the volume size reports the good size.</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Volume size adjusted to %u"</span>, volSize);</div><div class="line">    <span class="keywordflow">if</span> ((volSize != st.st_size) || (volSize != writeVolSize))</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"UBI voluma has bad size: %u, expected %u"</span>, volSize, writeVolSize);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --> <h1><a class="anchor" id="le_flash_GetBlockInformation"></a>
Retrieve information about blocks and pages for a</h1>
<p>partition. To get information about blocks and pages, call <a class="el" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation()</a>. The API will return:</p><ul>
<li>The number of bad blocks belonging to this partition</li>
<li>The number of erase blocks belonging to this partition</li>
<li>The erase block size</li>
<li>The page size The whole partition size in bytes can be computed by: number of erase blocks * erase block size The whole partition available size for read and write purpose can be computed by: (number of erase blocks - number of bad blocks) * erase block size</li>
</ul>
<p>A sample code showing how to open, retrieve information and close a partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Retrieve information about an open partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_Info</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize;</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given MTD partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a201ac5e6437c377c2c77ac25a0b0e0f0">le_flash_OpenMtd</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve MTD flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the MTD</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --> <h1><a class="anchor" id="le_flash_GetUbiVolumeInformation"></a>
Retrieve UBI information.</h1>
<p>To get information about an UBI volume, call <a class="el" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation()</a>. The API will return:</p><ul>
<li>The number of free blocks in the whole UBI partition</li>
<li>The currently number of blocks allocated to the UBI volume</li>
<li>The real size of the UBI volume This API must be called after the UBI volume has been open by <a class="el" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume()</a>.</li>
</ul>
<p>A sample code showing how to open UBI, retrieve UBI information and close UBI can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Retrieve information about an UBI volume</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_InfoUbi</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize;</div><div class="line">    uint32_t freeBlock, volBlock, volSize;</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in R/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_READ_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open an UBI volume belonging to this UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume</a>(partRef, ubiVolStr, <a class="code" href="le__flash__interface_8h.html#a665479827533ef84335f7b2fb2a21b52">LE_FLASH_UBI_VOL_NO_SIZE</a>);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Free Block %u, Allocated Block to Volume %u, Volume Size %u"</span>,</div><div class="line">            freeBlock, volBlock, volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --> <h1><a class="anchor" id="le_flash_CreateUbi"></a>
Create an UBI partition and volume</h1>
<p><a class="el" href="le__flash__interface_8h.html#ac89478424c0faf00d59dbfe0c5d135ac">le_flash_CreateUbi()</a> is used to create an UBI partition. If the partition is already an UBI, an error LE_DUPLICATE will be reported. The overwrite of the partition can be forced by setting the flag isForcedCreate to true (all previous content will be lost).</p>
<p>When the creation succeeded, the UBI device is opened using <a class="el" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi()</a> with LE_FLASH_READWRITE mode.</p>
<p>To create a new volume in the created UBI partition, <a class="el" href="le__flash__interface_8h.html#a821742a3f7ae388b6a337917cc5ee176">le_flash_CreateUbiVolume()</a> has to be called. If a volume already exists with the same name or same ID, an error LE_DUPLICATE will be reported. The flag isForcedCreate permits to re-create the volume, but the previous content of the volume will be lost.</p>
<p>The created volume can be opened using the <a class="el" href="le__flash__interface_8h.html#a30777595484051e349c41005cbe567a1">le_flash_OpenUbiVolume()</a> API.</p>
<p>An existing volume can be deleted thanks to <a class="el" href="le__flash__interface_8h.html#a3878530d7d57eb120267d34c67d5d163">le_flash_DeleteUbiVolume()</a>.</p>
<p>Please refer to <a class="el" href="platformConstraintsFlash.html">Flash</a> for details.</p>
<p>A sample code showing how to create an UBI partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Create an UBI partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_CreateUbi</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t badBlock, numBlock, eraseBlockSize, pageSize;</div><div class="line"> </div><div class="line">    <span class="comment">// Create and open the given UBI partition in W/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac89478424c0faf00d59dbfe0c5d135ac">le_flash_CreateUbi</a>(partNameStr, <span class="keyword">true</span>, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" create ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI flash information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a62fb368ac8627c1757ca7003d93753e7">le_flash_GetBlockInformation</a>(partRef, &amp;badBlock, &amp;numBlock, &amp;eraseBlockSize, &amp;pageSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Bad Block %u, Block %u, Erase Block Size %u, Page Size %u"</span>,</div><div class="line">            badBlock, numBlock, eraseBlockSize, pageSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> A sample code showing how to create an UBI volume inside an UBI partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Create an UBI volume into an UBI partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_CreateUbiVol</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolIdStr = args[2];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolTypeStr = args[3];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolSizeStr = args[4];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a2ff1ef7f1fa75e75af9deccd217f724a">le_flash_UbiVolumeType_t</a> ubiVolType;</div><div class="line">    int32_t ubiVolId, ubiVolSize;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line">    uint32_t freeBlock, volBlock, volSize;</div><div class="line"> </div><div class="line">    <span class="keywordflow">if</span> (0 == strcmp(ubiVolTypeStr, <span class="stringliteral">"dynamic"</span>))</div><div class="line">    {</div><div class="line">        ubiVolType = LE_FLASH_DYNAMIC;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strcmp(ubiVolTypeStr, <span class="stringliteral">"static"</span>))</div><div class="line">    {</div><div class="line">        ubiVolType = LE_FLASH_STATIC;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Incorrect volume type '%s'. Must be dynamic or static."</span>, ubiVolTypeStr);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cabe505065132f6e8850da6f476d8fb783">LE_BAD_PARAMETER</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keywordflow">if</span> ((1 != sscanf( ubiVolIdStr, <span class="stringliteral">"%d"</span>, &amp;ubiVolId )) || (ubiVolId &gt; <a class="code" href="le__flash__interface_8h.html#adac0338ad0295e82f011e1abdd30ce3d">LE_FLASH_UBI_VOL_ID_MAX</a>))</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Invalid volume Id '%s'"</span>, ubiVolIdStr);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cabe505065132f6e8850da6f476d8fb783">LE_BAD_PARAMETER</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keywordflow">if</span> (1 != sscanf( ubiVolSizeStr, <span class="stringliteral">"%d"</span>, &amp;ubiVolSize ))</div><div class="line">    {</div><div class="line">        <a class="code" href="le__log_8h.html#a353590f91b3143a7ba3a416ae5a50c3d">LE_ERROR</a>(<span class="stringliteral">"Invalid volume Size '%s'"</span>, ubiVolSizeStr);</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cabe505065132f6e8850da6f476d8fb783">LE_BAD_PARAMETER</a>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in W/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_WRITE_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Create an UBI volume belonging to this UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a821742a3f7ae388b6a337917cc5ee176">le_flash_CreateUbiVolume</a>(partRef, <span class="keyword">true</span>, ubiVolId, ubiVolType, ubiVolStr, ubiVolSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" id %u created ref %p, res %d"</span>, ubiVolStr, ubiVolId, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Retrieve UBI volume information</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ac83627b7aac9aef8f2a921b0d210771d">le_flash_GetUbiVolumeInformation</a>(partRef, &amp;freeBlock, &amp;volBlock, &amp;volSize);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"Free Block %u, Allocated Block to Volume %u, Volume Size %u"</span>,</div><div class="line">            freeBlock, volBlock, volSize);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI volume</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a775b88378bd1e99ac9fc7578eb45ea45">le_flash_CloseUbiVolume</a>(partRef);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> A sample code showing how to delete an UBI volume from an UBI partition can be seen below: </p><pre class="fragment"><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Delete an UBI volume from a partition</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> FlashApiTest_DeleteUbiVol</div><div class="line">(</div><div class="line">    <span class="keywordtype">char</span> **args</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *partNameStr = args[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ubiVolStr = args[1];</div><div class="line">    <a class="code" href="le__flash__interface_8h.html#a38b1fbb1ffed1bceeb4f39679bda3b4d">le_flash_PartitionRef_t</a> partRef = NULL;</div><div class="line">    <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86c">le_result_t</a> res;</div><div class="line"> </div><div class="line">    <span class="comment">// Open the given UBI partition in W/O</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a952dd12d255eca1b408b15465256c8f7">le_flash_OpenUbi</a>(partNameStr, LE_FLASH_WRITE_ONLY, &amp;partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" open ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Delete the UBI volume from the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#a3878530d7d57eb120267d34c67d5d163">le_flash_DeleteUbiVolume</a>(partRef, ubiVolStr);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"UBI volume \"%s\" open ref %p, res %d"</span>, ubiVolStr, partRef, res);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86ca5066a4bcec691c6b67843b8f79656422">LE_OK</a> != res)</div><div class="line">    {</div><div class="line">        <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// Close the UBI partition</span></div><div class="line">    res = <a class="code" href="le__flash__interface_8h.html#ad35822ce512be4c76ede295618fd292f">le_flash_Close</a>(partRef);</div><div class="line">    <a class="code" href="le__log_8h.html#a23e6d206faa64f612045d688cdde5808">LE_INFO</a>(<span class="stringliteral">"partition \"%s\" close ref %p, res %d"</span>, partNameStr, partRef, res);</div><div class="line"> </div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div></pre><!-- fragment --><p> This API is synchronous: it is blocking until the write is over. After the end of the write, the data are read to ensure the data has been saved correctly.</p>
<hr/>
<p class="copyright">Copyright (C) Sierra Wireless Inc. </p>
</div></div>
<br clear="left"/>
</div>
</div>
<link href="resources/css/jqtree.css" rel="stylesheet" type="text/css"/>
<script src="resources/js/tree.jquery.js" type="text/javascript"></script>
<script src="resources/js/jquery.cookie.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<link href="resources/css/perfect-scrollbar.min.css" rel="stylesheet"/>
<script src="resources/js/perfect-scrollbar.jquery.min.js"></script>
</body>
</html>
